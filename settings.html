<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SlideMaker • Settings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/chatbot.css">
    <!-- DISABLE ALL ANIMATIONS FOR PERFORMANCE TEST -->
    <link rel="stylesheet" href="./css/disable-animations.css">
    <script src="./translations.js"></script>
    <script src="./scripts/database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onload="console.log('[QR] qrcodejs library loaded successfully');" onerror="console.error('[QR ERROR] Failed to load qrcodejs library');"></script>
    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body {
        font-family: Poppins, sans-serif;
        background: #0b3d2e;
        color: #E8F5E9;
        transition: background-color 0.3s ease;
      }

      /* Header per settings.json */
      header {
        position: sticky; top: 0; z-index: 10;
        background: #0b3d2e;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      .nav { max-width: 1200px; margin: 0 auto; padding: 12px 20px; display: flex; align-items: center; gap: 16px; }
      .logo { font-weight: 700; letter-spacing: .2px; color: white; }
      .menu { display: flex; gap: 12px; }
      .menu a { color: white; font-weight: 600; padding: 8px 10px; border-radius: 8px; transition: opacity .2s; }
      .menu a:hover { opacity: 0.8; }
      .spacer { flex: 1; }

      /* Settings page */
      .container { max-width: 1400px; margin: 0 auto; padding: 48px 24px; }
      h1 { font-size: 32px; margin: 0 0 40px; color: #E8F5E9; text-align: left; }
      body.light-mode h1 { color: #0d3b2c; }

      /* Profile card wrapper - centered at top */
      .profile-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
      }

      .profile-wrapper .profile-card {
        max-width: 600px;
        width: 100%;
      }

      /* Two-column layout: sidebar + content */
      .settings-main-layout {
        display: flex;
        gap: 32px;
        align-items: flex-start;
      }

      /* Left Sidebar */
      .settings-sidebar {
        width: 240px;
        flex-shrink: 0;
        background: linear-gradient(145deg, rgba(13, 53, 38, 0.9), rgba(9, 34, 24, 0.84));
        border: 1px solid rgba(46, 213, 115, 0.2);
        border-radius: 24px;
        padding: 24px 0;
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(24px);
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }

      .settings-tabs {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .sidebar-tab {
        padding: 14px 24px;
        color: #E8F5E9;
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.2px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
        border-radius: 12px;
        text-align: left;
        display: block;
        margin: 0 8px;
      }

      .sidebar-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #E8F5E9;
      }

      .sidebar-tab.active {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.25), rgba(26, 188, 156, 0.25));
        color: #2ed573;
        box-shadow: 0 4px 16px rgba(46, 213, 115, 0.3);
        border: 1px solid rgba(46, 213, 115, 0.4);
      }

      body.light-mode .settings-sidebar {
        background: linear-gradient(145deg, rgba(233, 248, 240, 0.95), rgba(203, 240, 223, 0.9));
        border: 1px solid rgba(26, 156, 109, 0.2);
      }

      body.light-mode .sidebar-tab {
        color: #0d3b2c;
      }

      body.light-mode .sidebar-tab:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      body.light-mode .sidebar-tab.active {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.3), rgba(26, 188, 156, 0.3));
        color: #1a7c5a;
        border: 1px solid rgba(46, 213, 115, 0.5);
      }

      /* Content Area */
      .settings-content {
        flex: 1;
        min-width: 0;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
      
      .settings-card {
        background: linear-gradient(145deg, rgba(13, 53, 38, 0.9), rgba(9, 34, 24, 0.84));
        border: 1px solid rgba(46, 213, 115, 0.22);
        border-radius: 24px;
        padding: 32px;
        backdrop-filter: blur(24px);
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.28);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .settings-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 48px rgba(0, 0, 0, 0.32);
      }

      .settings-card > h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        color: inherit;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .settings-card > .form-group:last-child {
        margin-bottom: 0;
      }

      .form-label {
        display: block;
        margin-bottom: 12px;
        color: #E8F5E9;
        font-weight: 600;
        font-size: 16px;
      }

      .color-options {
        display: flex;
        flex-direction: column;
        gap: 0;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .color-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
        overflow: hidden;
      }

      .color-option:last-child {
        border-bottom: none;
      }

      .color-option::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .color-option:hover::before {
        opacity: 1;
      }

      .color-option:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateX(4px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .color-option[data-selected="true"] {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.3) 0%, rgba(16, 185, 129, 0.2) 100%);
        backdrop-filter: blur(25px);
        border-left: 3px solid #2ed573;
        box-shadow: inset 0 0 20px rgba(46, 213, 115, 0.1);
      }

      .color-option.focused {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.3) 100%);
        backdrop-filter: blur(25px);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3), inset 0 0 20px rgba(59, 130, 246, 0.1);
      }

      .check-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2ed573;
        font-weight: 700;
        font-size: 14px;
        position: relative;
        z-index: 1;
      }

      .color-label {
        color: #E8F5E9;
        font-size: 16px;
        font-weight: 500;
        position: relative;
        z-index: 1;
      }

      .color-option.focused .color-label {
        color: #ffffff;
      }

      /* Light mode text colors for better readability */
      body.light-mode .color-label {
        color: #1a1a1a !important;
      }

      body.light-mode .color-option.focused .color-label {
        color: #ffffff !important;
      }

      body.light-mode .color-option[data-selected="true"] .color-label {
        color: #1a1a1a !important;
      }

      body.light-mode .check-icon {
        color: #10b981 !important;
      }

      /* Theme preview overrides */
      #backgroundSelector {
        border-radius: 20px;
        border: none;
        background: transparent;
        padding: 0;
        display: grid;
        gap: 20px;
      }

      @media (min-width: 701px) {
        #backgroundSelector {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      @media (max-width: 700px) {
        #backgroundSelector {
          grid-template-columns: 1fr;
        }
      }

      #backgroundSelector .color-option {
        flex-direction: column;
        align-items: stretch;
        border-left: none;
        border-bottom: none;
        border-radius: 18px;
        padding: 18px 20px 20px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        transform: none;
      }

      #backgroundSelector .color-option::before,
      #backgroundSelector .color-option.focused::before {
        display: none;
      }

      #backgroundSelector .color-option:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.32);
        border-color: rgba(46, 213, 115, 0.35);
      }

      #backgroundSelector .color-option[data-selected="true"] {
        border-color: rgba(46, 213, 115, 0.6);
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.4);
        background: linear-gradient(145deg, rgba(46, 213, 115, 0.28), rgba(21, 71, 52, 0.4));
      }

      #backgroundSelector .color-option .theme-preview {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.2);
        height: 96px;
      }

      #backgroundSelector .color-option .theme-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        filter: saturate(1.05);
      }

      #backgroundSelector .color-option .theme-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      #backgroundSelector .color-option .color-label {
        font-size: 16px;
        font-weight: 600;
        color: #E8F5E9;
      }

      #backgroundSelector .color-option .check-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.35);
        background: rgba(11, 61, 46, 0.45);
        font-size: 18px;
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      }

      #backgroundSelector .color-option[data-selected="true"] .check-icon {
        background: linear-gradient(135deg, #2ed573, #1abc9c);
        border-color: transparent;
        color: #0d3b2c;
      }

      body.light-mode #backgroundSelector .color-option {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      body.light-mode #backgroundSelector .color-option[data-selected="true"] {
        background: linear-gradient(145deg, rgba(233, 248, 240, 0.9), rgba(213, 245, 230, 0.9));
        border-color: rgba(26, 156, 109, 0.35);
      }

      body.light-mode #backgroundSelector .color-option .color-label {
        color: #0d3b2c;
      }

      body.light-mode #backgroundSelector .color-option .check-icon {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(13, 59, 44, 0.2);
        color: #0d3b2c;
      }

      body.light-mode #backgroundSelector .color-option[data-selected="true"] .check-icon {
        background: linear-gradient(135deg, #2ed573, #1abc9c);
        border-color: transparent;
        color: #ffffff;
      }

      /* App customization */
      .app-customization-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .customization-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .customization-group:last-child {
        border-bottom: none;
      }

      .customization-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 70%;
      }

      .customization-details h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .customization-details p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      .density-select {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .density-select span {
        pointer-events: none;
      }

      .density-select::after {
        content: "⌄";
        font-size: 14px;
        opacity: 0.75;
      }

      .density-select select {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .density-select:hover {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.35);
      }

      body.light-mode .density-select {
        color: #1a1a1a;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: rgba(0, 0, 0, 0.04);
      }

      body.light-mode .density-select:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      .back-link {
        display: inline-block;
        margin-top: 24px;
        color: #A5D6A7;
        text-decoration: none;
        font-weight: 600;
      }

      .back-link:hover {
        color: #E8F5E9;
      }

      /* Dark metallic gradient background */
      body.dark-theme {
        background: linear-gradient(135deg, #0b0b0b 0%, #0d0d0d 40%, #000000 100%);
        background-attachment: fixed;
        background-repeat: no-repeat;
        background-size: cover;
        color: #eaeaea;
        position: relative;
      }

      body.dark-theme::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.05), transparent 60%);
        pointer-events: none;
        z-index: 0;
      }

      body.dark-theme > * {
        position: relative;
        z-index: 1;
      }

      header.dark-theme {
        background: linear-gradient(135deg, #0b0b0b 0%, #0d0d0d 40%, #000000 100%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Light mode background with frosted glass effect */
      body.light-mode {
        background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(240,240,240,0.8));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #1a1a1a;
        transition: all 0.3s ease-in-out;
        position: relative;
      }

      body.light-mode > * {
        position: relative;
        z-index: 1;
      }

      header.light-mode {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      /* Card or container glass effect */
      body.light-mode .settings-card {
        background: linear-gradient(145deg, rgba(233, 248, 240, 0.95), rgba(203, 240, 223, 0.9));
        border: 1px solid rgba(26, 156, 109, 0.2);
        border-radius: 24px;
        box-shadow: 0 18px 32px rgba(0, 0, 0, 0.12);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
      }

      .about-list {
        list-style: none;
        padding: 0;
        margin: 12px 0 0;
        font-size: 15px;
        line-height: 1.8;
        color: inherit;
      }

      .about-list a {
        color: #2ed573;
        text-decoration: none;
      }

      .about-list a:hover {
        text-decoration: underline;
      }

      /* Profile card */
      .profile-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        text-align: center;
      }

      /* Profile card inside tab content - align left */
      .tab-content .profile-card {
        align-items: flex-start;
        text-align: left;
      }

      .tab-content .profile-card .profile-info {
        align-items: flex-start;
      }

      .tab-content .profile-card .profile-actions {
        align-self: flex-start;
      }

      .profile-card .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        border: 4px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      }

      .profile-card .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .profile-card .profile-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }

      .profile-card .profile-name {
        font-size: 20px;
        font-weight: 600;
        color: #FFFFFF;
        margin: 0;
      }

      .profile-card .profile-email {
        font-size: 15px;
        opacity: 0.85;
        color: inherit;
      }

      body.light-mode .profile-card .profile-name {
        color: #0d3b2c;
      }
      .settings-layout {
        display: grid;
        gap: 32px;
      }

      .settings-layout > * {
        width: 100%;
      }

      .settings-row-two {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        width: 100%;
      }

      .settings-row-two > .settings-card {
        height: 100%;
      }

      .settings-row-two .app-customization-section {
        max-width: 100%;
      }

      @media (min-width: 900px) {
        .settings-layout {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .settings-layout > .profile-card {
          grid-column: span 2;
        }

        .settings-layout > .form-settings-card {
          grid-column: span 2;
        }

        .settings-layout > .settings-row-two {
          grid-column: span 2;
        }

        .settings-layout > #aboutCard {
          grid-column: span 2;
        }
      }

      .profile-card .profile-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      .profile-edit-btn {
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #2ed573, #1abc9c);
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.3px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .profile-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(46, 213, 115, 0.25);
      }

      .profile-edit-btn:focus {
        outline: 2px solid rgba(46, 213, 115, 0.6);
        outline-offset: 2px;
      }

      .profile-edit-btn:active {
        transform: translateY(0);
      }

      /* Profile Editable Fields */
      .profile-field {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        padding: 20px 22px;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 14px;
        margin-bottom: 20px;
      }

      .profile-field:last-child {
        margin-bottom: 0;
      }

      /* Readonly fields styling */
      .profile-field[data-readonly="true"] {
        opacity: 0.9;
      }

      .profile-field[data-readonly="true"] .field-value {
        background: rgba(255, 255, 255, 0.04);
        cursor: not-allowed;
      }

      /* QR Code container */
      .qr-code-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 14px;
      }

      .qr-code-container #userQRCode {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 200px;
      }
      
      .qr-code-container #userQRCode canvas,
      .qr-code-container #userQRCode img {
        max-width: 180px;
        height: auto;
        display: block;
      }

      .field-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .field-label {
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.2px;
        color: #E8F5E9;
      }

      .field-actions {
        display: flex;
        gap: 8px;
      }

      .field-edit-btn,
      .field-save-btn,
      .field-cancel-btn {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.14);
        color: #E8F5E9;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        letter-spacing: 0.2px;
        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      }

      .field-edit-btn:hover {
        background: rgba(255, 255, 255, 0.22);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
      }

      .field-save-btn {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.3), rgba(26, 188, 156, 0.3));
        color: #2ed573;
      }

      .field-save-btn:hover {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.4), rgba(26, 188, 156, 0.4));
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(46, 213, 115, 0.3);
      }

      .field-cancel-btn {
        background: rgba(255, 255, 255, 0.1);
      }

      .field-cancel-btn:hover {
        background: rgba(255, 255, 255, 0.18);
        transform: translateY(-1px);
      }

      .field-value {
        font-size: 16px;
        color: #E8F5E9;
        padding: 14px 16px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.06);
        min-height: 48px;
        display: flex;
        align-items: center;
      }

      .field-value.hidden {
        display: none;
      }

      .field-input {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        padding: 14px 16px;
        color: #E8F5E9;
        font-size: 16px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .field-input:focus {
        border-color: rgba(46, 213, 115, 0.6);
        box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.2);
      }

      .field-select {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        padding: 14px 16px;
        color: #E8F5E9;
        font-size: 16px;
        font-family: inherit;
        outline: none;
        cursor: pointer;
        appearance: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .field-select:focus {
        border-color: rgba(46, 213, 115, 0.6);
        box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.2);
      }

      .field-textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        padding: 14px 16px;
        color: #E8F5E9;
        font-size: 16px;
        font-family: inherit;
        outline: none;
        min-height: 120px;
        resize: vertical;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .field-textarea:focus {
        border-color: rgba(46, 213, 115, 0.6);
        box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.2);
      }

      .field-input.hidden,
      .field-select.hidden,
      .field-textarea.hidden {
        display: none;
      }

      body.light-mode .field-label {
        color: #0d3b2c;
      }

      body.light-mode .field-value {
        color: #0d3b2c;
        background: rgba(0, 0, 0, 0.04);
      }

      body.light-mode .field-input,
      body.light-mode .field-select,
      body.light-mode .field-textarea {
        color: #0d3b2c;
        background: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.15);
      }

      /* Profile Picture Section */
      .profile-picture-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 32px 0;
        margin-bottom: 32px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }

      .profile-avatar-container {
        position: relative;
        width: 140px;
        height: 140px;
      }

      .profile-avatar-display {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.3);
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15), rgba(11, 61, 46, 0.8));
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .profile-avatar-display:hover {
        transform: scale(1.05);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.4);
      }

      .profile-avatar-display img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .change-photo-btn {
        padding: 10px 24px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(26, 188, 156, 0.2));
        color: #2ed573;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(46, 213, 115, 0.3);
      }

      .change-photo-btn:hover {
        transform: translateY(-1px);
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.3), rgba(26, 188, 156, 0.3));
        box-shadow: 0 6px 16px rgba(46, 213, 115, 0.25);
      }

      /* Avatar Modal */
      .avatar-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(5, 15, 10, 0.72);
        backdrop-filter: blur(16px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 10000;
      }

      .avatar-modal-overlay.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .avatar-modal-card {
        width: min(520px, 90vw);
        max-height: 90vh;
        overflow-y: auto;
        border-radius: 24px;
        padding: 32px;
        background: linear-gradient(145deg, rgba(18, 53, 38, 0.95), rgba(8, 25, 18, 0.92));
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 24px;
        position: relative;
      }

      .avatar-modal-card h3 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        color: #E8F5E9;
      }

      .avatar-upload-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .avatar-upload-label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        border-radius: 12px;
        border: 2px dashed rgba(46, 213, 115, 0.4);
        background: rgba(46, 213, 115, 0.1);
        color: #2ed573;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      }

      .avatar-upload-label:hover {
        background: rgba(46, 213, 115, 0.15);
        border-color: rgba(46, 213, 115, 0.6);
        transform: translateY(-1px);
      }

      .avatar-upload-label input[type="file"] {
        display: none;
      }

      .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid rgba(46, 213, 115, 0.4);
        overflow: hidden;
        margin: 0 auto;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15), rgba(11, 61, 46, 0.8));
      }

      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .avatar-presets-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .avatar-presets-title {
        font-size: 16px;
        font-weight: 600;
        color: #E8F5E9;
        margin: 0;
      }

      .avatar-presets-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .avatar-preset-item {
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.08);
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        position: relative;
      }

      .avatar-preset-item:hover {
        transform: translateY(-2px);
        border-color: rgba(46, 213, 115, 0.5);
        box-shadow: 0 8px 20px rgba(46, 213, 115, 0.2);
      }

      .avatar-preset-item.selected {
        border-color: #2ed573;
        box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.3);
      }

      .avatar-preset-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .avatar-preset-item::after {
        content: '✓';
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2ed573, #1abc9c);
        color: #0d3b2c;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .avatar-preset-item.selected::after {
        opacity: 1;
      }

      .avatar-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .avatar-modal-save,
      .avatar-modal-cancel {
        padding: 10px 24px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .avatar-modal-save {
        background: linear-gradient(135deg, #2ed573, #1abc9c);
        color: #0d3b2c;
      }

      .avatar-modal-save:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(46, 213, 115, 0.35);
      }

      .avatar-modal-cancel {
        background: rgba(255, 255, 255, 0.08);
        color: #E8F5E9;
      }

      .avatar-modal-cancel:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      body.light-mode .avatar-modal-card {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      body.light-mode .avatar-modal-card h3,
      body.light-mode .avatar-presets-title {
        color: #0d3b2c;
      }

      body.light-mode .avatar-upload-label {
        border-color: rgba(26, 188, 156, 0.4);
        background: rgba(26, 188, 156, 0.1);
        color: #1a7c5a;
      }

      body.light-mode .avatar-modal-cancel {
        background: rgba(0, 0, 0, 0.05);
        color: #0d3b2c;
      }

      @media (max-width: 600px) {
        .avatar-presets-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      /* Account & Security */
      .security-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .security-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .security-row:last-child {
        border-bottom: none;
      }

      .security-text {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 70%;
      }

      .security-text h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .security-text p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      .security-button {
        padding: 10px 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .security-button:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      }

      .security-button:focus {
        outline: 2px solid rgba(46, 213, 115, 0.6);
        outline-offset: 2px;
      }

      body.light-mode .security-button {
        color: #1a1a1a;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: rgba(0, 0, 0, 0.04);
      }

      body.light-mode .security-button:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      .security-toggle {
        position: relative;
        width: 56px;
        height: 30px;
      }

      .security-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: not-allowed;
        inset: 0;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 999px;
        transition: background 0.2s ease;
      }

      .toggle-slider::before {
        content: "";
        position: absolute;
        height: 24px;
        width: 24px;
        left: 3px;
        top: 3px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 50%;
        transition: transform 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .security-toggle input:checked + .toggle-slider {
        background: linear-gradient(135deg, #2ed573, #1abc9c);
      }

      .security-toggle input:checked + .toggle-slider::before {
        transform: translateX(26px);
      }

      body.light-mode .toggle-slider {
        background: rgba(0, 0, 0, 0.1);
      }

      body.light-mode .toggle-slider::before {
        background: #ffffff;
      }

      /* Preferences */
      .preferences-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .preference-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .preference-row:last-child {
        border-bottom: none;
      }

      .preference-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 70%;
      }

      .preference-details h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .preference-details p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      .font-size-options {
        display: inline-flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 999px;
        padding: 4px;
        gap: 6px;
      }

      .font-size-button {
        padding: 8px 16px;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: inherit;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      }

      .font-size-button.is-active {
        background: linear-gradient(135deg, rgba(46, 213, 115, 0.35), rgba(26, 188, 156, 0.35));
        color: #ffffff;
        transform: translateY(-1px);
      }

      .font-size-button:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      body.light-mode .font-size-options {
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.12);
      }

      body.light-mode .font-size-button {
        color: #1a1a1a;
      }

      body.light-mode .font-size-button.is-active {
        color: #1a1a1a;
        background: rgba(26, 188, 156, 0.24);
      }

      /* Font Size Classes */
      body.normal-font {
        font-size: 16px;
      }

      body.large-font {
        font-size: 18px;
      }

      body.large-font h1 {
        font-size: 36px;
      }

      body.large-font h2 {
        font-size: 24px;
      }

      body.large-font h3 {
        font-size: 20px;
      }

      body.large-font .sidebar-tab {
        font-size: 16px;
      }

      body.large-font .field-label,
      body.large-font .form-label {
        font-size: 16px;
      }

      body.large-font .field-value,
      body.large-font .field-input,
      body.large-font .field-select,
      body.large-font .field-textarea {
        font-size: 17px;
      }

      /* Animations Control */
      body:not(.animations-on) *,
      body:not(.animations-on) *::before,
      body:not(.animations-on) *::after {
        animation-duration: 0s !important;
        animation-delay: 0s !important;
        transition-duration: 0s !important;
        transition-delay: 0s !important;
      }

      body.animations-on * {
        transition-duration: 0.2s;
        transition-timing-function: ease;
      }

      /* Rounded Corners UI */
      body.rounded-ui * {
        border-radius: 10px !important;
      }

      body.rounded-ui .settings-card,
      body.rounded-ui .profile-field,
      body.rounded-ui .sidebar-tab,
      body.rounded-ui button,
      body.rounded-ui input,
      body.rounded-ui select,
      body.rounded-ui textarea {
        border-radius: 10px !important;
      }

      /* Glass Effect UI */
      body.glass-ui .settings-card,
      body.glass-ui .settings-sidebar,
      body.glass-ui .profile-card {
        backdrop-filter: blur(20px) saturate(1.2);
        background: rgba(255, 255, 255, 0.08);
      }

      body.glass-ui .modal-card {
        backdrop-filter: blur(24px) saturate(1.3);
        background: rgba(18, 53, 38, 0.85);
      }

      /* UI Density Classes */
      body.ui-density-compact * {
        padding: calc(var(--density-multiplier, 1) * 0.75);
        gap: calc(var(--density-multiplier, 1) * 0.75);
      }

      body.ui-density-compact .settings-card {
        padding: 20px;
        gap: 16px;
      }

      body.ui-density-compact .sidebar-tab {
        padding: 10px 20px;
      }

      body.ui-density-compact .profile-field {
        padding: 16px 18px;
        gap: 12px;
      }


      body.ui-density-spacious .settings-card {
        padding: 48px;
        gap: 32px;
      }

      body.ui-density-spacious .sidebar-tab {
        padding: 18px 28px;
      }

      body.ui-density-spacious .profile-field {
        padding: 28px 30px;
        gap: 20px;
      }

      body.ui-density-spacious .customization-group,
      body.ui-density-spacious .preference-row,
      body.ui-density-spacious .notification-row,
      body.ui-density-spacious .collaboration-row {
        padding: 24px 0;
        gap: 32px;
      }

      /* Notifications */
      .notifications-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .notification-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .notification-row:last-child {
        border-bottom: none;
      }

      .notification-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 70%;
      }

      .notification-details h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .notification-details p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      /* Collaboration */
      .collaboration-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .collaboration-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .collaboration-row:last-child {
        border-bottom: none;
      }

      .collaboration-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-width: 70%;
      }

      .collaboration-details h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .collaboration-details p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      .collaboration-select {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .collaboration-select span {
        pointer-events: none;
      }

      .collaboration-select::after {
        content: "⌄";
        font-size: 14px;
        opacity: 0.75;
      }

      .collaboration-select:hover {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      }

      body.light-mode .collaboration-select {
        color: #1a1a1a;
        border-color: rgba(0, 0, 0, 0.15);
        background: rgba(0, 0, 0, 0.04);
      }

      body.light-mode .collaboration-select:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      .collaboration-select select {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Connected Accounts */
      .connections-section {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .connection-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .connection-item:last-child {
        border-bottom: none;
      }

      .connection-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .connection-details h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .connection-details p {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.85;
      }

      .connection-button {
        padding: 10px 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .connection-button:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      }

      .connection-button.connected {
        background: rgba(46, 213, 115, 0.15);
        border-color: rgba(46, 213, 115, 0.4);
        color: #2ed573;
        cursor: default;
        opacity: 0.8;
      }

      .connection-button.connected:hover {
        transform: none;
        background: rgba(46, 213, 115, 0.15);
        box-shadow: none;
      }

      body.light-mode .connection-button {
        color: #1a1a1a;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: rgba(0, 0, 0, 0.04);
      }

      body.light-mode .connection-button:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      /* Responsive layout tweaks */
      @media (max-width: 900px) {
        .settings-main-layout {
          flex-direction: column;
        }

        .settings-sidebar {
          width: 100%;
          position: relative;
          top: 0;
          max-height: none;
        }

        .settings-tabs {
          flex-direction: row;
          overflow-x: auto;
          padding: 0 16px;
        }

        .sidebar-tab {
          border-radius: 999px;
          white-space: nowrap;
          margin: 0;
        }

        .profile-card {
          align-items: flex-start;
        }
        
        .settings-row-two {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .profile-card {
          flex-direction: column;
          text-align: center;
        }

        .profile-card .profile-info,
        .profile-card .profile-actions {
          width: 100%;
          align-items: center;
        }

        .profile-card .profile-actions {
          justify-content: center;
        }

        .security-row,
        .preference-row,
        .notification-row,
        .collaboration-row,
        .connection-item,
        .customization-group {
          flex-direction: column;
          align-items: flex-start;
          width: 100%;
        }

        .security-text,
        .preference-details,
        .notification-details,
        .collaboration-details,
        .connection-details {
          max-width: 100%;
        }

        .security-button,
        .delete-button,
        .collaboration-select,
        .connection-button,
        .font-size-options,
        .density-select {
          width: 100%;
          justify-content: center;
        }

        .font-size-options {
          justify-content: space-between;
        }

        .font-size-button {
          flex: 1;
        }

        .security-toggle {
          align-self: flex-start;
        }
      }

      .delete-button {
        padding: 10px 22px;
        border-radius: 12px;
        border: 1px solid rgba(220, 53, 69, 0.5);
        background: rgba(220, 53, 69, 0.12);
        color: #ff6b6b;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .delete-button:hover {
        transform: translateY(-1px);
        background: rgba(220, 53, 69, 0.18);
        box-shadow: 0 6px 14px rgba(220, 53, 69, 0.25);
      }

      .delete-button:focus {
        outline: 2px solid rgba(220, 53, 69, 0.5);
        outline-offset: 2px;
      }

      body.light-mode .delete-button {
        color: #c0392b;
        background: rgba(192, 57, 43, 0.08);
        border: 1px solid rgba(192, 57, 43, 0.4);
      }

      body.light-mode .delete-button:hover {
        background: rgba(192, 57, 43, 0.14);
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(5, 15, 10, 0.72);
        backdrop-filter: blur(16px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .modal-overlay.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-card {
        width: min(420px, 90vw);
        border-radius: 20px;
        padding: 28px 32px;
        background: linear-gradient(145deg, rgba(18, 53, 38, 0.95), rgba(8, 25, 18, 0.92));
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
      }

      body.light-mode .modal-card {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
      }

      .modal-card h3 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      .modal-card p {
        margin: 0;
        font-size: 14px;
        line-height: 1.7;
        opacity: 0.88;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .modal-close,
      .modal-confirm {
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .modal-close {
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
      }

      .modal-confirm {
        background: linear-gradient(135deg, #ff5f6d, #ffc371);
        color: #ffffff;
      }

      .modal-confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(255, 95, 109, 0.35);
      }

      body.light-mode .modal-close {
        background: rgba(0, 0, 0, 0.05);
        color: #1a1a1a;
      }

      body.light-mode .modal-close:hover {
        background: rgba(0, 0, 0, 0.08);
      }

      /* Modal Form Fields */
      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .modal-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .modal-form-label {
        font-size: 14px;
        font-weight: 600;
        color: #E8F5E9;
      }

      .modal-form-input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        padding: 12px 16px;
        color: #E8F5E9;
        font-size: 15px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .modal-form-input:focus {
        border-color: rgba(46, 213, 115, 0.6);
        box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.2);
      }

      .modal-form-error {
        font-size: 12px;
        color: #ff6b6b;
        margin-top: -4px;
        display: none;
      }

      .modal-form-error.show {
        display: block;
      }

      body.light-mode .modal-form-label {
        color: #0d3b2c;
      }

      body.light-mode .modal-form-input {
        color: #0d3b2c;
        background: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.15);
      }

      /* About Modal - Special Styling */
      .about-modal-overlay {
        z-index: 9999;
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .about-modal-card {
        width: min(560px, 90vw);
        padding: 40px;
        background: linear-gradient(145deg, rgba(13, 53, 38, 0.95), rgba(9, 34, 24, 0.92));
        border: 1px solid rgba(0, 222, 168, 0.3);
        box-shadow: 0 24px 60px rgba(0, 50, 30, 0.45), 0 0 60px rgba(0, 200, 83, 0.2);
        backdrop-filter: blur(24px);
        position: relative;
        animation: slideInUp 0.4s ease;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .about-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #a9d9c1;
        font-size: 20px;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .about-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        transform: rotate(90deg);
      }

      .about-modal-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .about-modal-title {
        font-size: 28px;
        font-weight: 700;
        color: #fff;
        margin: 0 0 8px 0;
        text-align: center;
        line-height: 1.3;
      }

      .about-modal-description {
        font-size: 16px;
        line-height: 1.7;
        color: #a9d9c1;
        margin: 0;
        text-align: center;
      }

      .about-modal-features {
        list-style: none;
        padding: 0;
        margin: 16px 0 0 0;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .about-modal-features li {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 15px;
        color: #E8F5E9;
        padding: 12px 16px;
        background: rgba(0, 200, 83, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(0, 200, 83, 0.15);
        transition: all 0.3s ease;
      }

      .about-modal-features li:hover {
        background: rgba(0, 200, 83, 0.15);
        border-color: rgba(0, 200, 83, 0.3);
        transform: translateX(4px);
      }

      .about-modal-features li i {
        color: #00c853;
        font-size: 18px;
        flex-shrink: 0;
      }

      body.light-mode .about-modal-card {
        background: linear-gradient(145deg, rgba(233, 248, 240, 0.98), rgba(203, 240, 223, 0.95));
        border: 1px solid rgba(26, 156, 109, 0.3);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.15), 0 0 40px rgba(46, 213, 115, 0.15);
      }

      body.light-mode .about-modal-close {
        background: rgba(0, 0, 0, 0.08);
        color: #1a7c5a;
      }

      body.light-mode .about-modal-close:hover {
        background: rgba(0, 0, 0, 0.15);
        color: #0d3b2c;
      }

      body.light-mode .about-modal-title {
        color: #0d3b2c;
      }

      body.light-mode .about-modal-description {
        color: #1a7c5a;
      }

      body.light-mode .about-modal-features li {
        color: #0d3b2c;
        background: rgba(46, 213, 115, 0.12);
        border-color: rgba(46, 213, 115, 0.25);
      }

      body.light-mode .about-modal-features li:hover {
        background: rgba(46, 213, 115, 0.2);
        border-color: rgba(46, 213, 115, 0.4);
      }

      body.light-mode .about-modal-features li i {
        color: #1a7c5a;
      }

      @media (max-width: 600px) {
        .about-modal-card {
          padding: 32px 24px;
        }

        .about-modal-title {
          font-size: 24px;
        }

        .about-modal-description {
          font-size: 15px;
        }

        .about-modal-features li {
          font-size: 14px;
          padding: 10px 14px;
        }
      }

      /* Toast/Snackbar */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: linear-gradient(145deg, rgba(18, 53, 38, 0.95), rgba(8, 25, 18, 0.92));
        border: 1px solid rgba(46, 213, 115, 0.3);
        border-radius: 12px;
        padding: 16px 20px;
        color: #E8F5E9;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(16px);
        z-index: 10000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: none;
        max-width: 320px;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .toast.success {
        border-color: rgba(46, 213, 115, 0.5);
        background: linear-gradient(145deg, rgba(18, 53, 38, 0.98), rgba(8, 25, 18, 0.95));
      }

      .toast.error {
        border-color: rgba(255, 107, 107, 0.5);
        background: linear-gradient(145deg, rgba(53, 18, 18, 0.98), rgba(25, 8, 8, 0.95));
      }

      body.light-mode .toast {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(26, 156, 109, 0.3);
        color: #0d3b2c;
      }

      body.light-mode .toast.success {
        border-color: rgba(46, 213, 115, 0.5);
      }

      body.light-mode .toast.error {
        border-color: rgba(255, 107, 107, 0.5);
      }

      /* Enable 2FA Toggle */
      .security-toggle input:not(:disabled) {
        cursor: pointer;
      }

      .security-toggle input:not(:disabled) + .toggle-slider {
        cursor: pointer;
      }

      /* Navigation colors */
      .nav a, .nav span, .logo {
        color: inherit;
        transition: color 0.3s ease;
      }

      body.light-mode .nav a,
      body.light-mode .nav span,
      body.light-mode .logo {
        color: #222;
      }

      body.dark-theme .nav a,
      body.dark-theme .nav span,
      body.dark-theme .logo {
        color: #eaeaea;
      }

      /* Headings */
      body.light-mode h1, 
      body.light-mode h2, 
      body.light-mode h3 {
        color: #1a1a1a !important;
      }

      body.dark-theme h1, 
      body.dark-theme h2, 
      body.dark-theme h3 {
        color: #f5f5f5;
      }

      /* Form labels and inputs in light mode */
      body.light-mode .form-label {
        color: #1a1a1a !important;
      }

      body.light-mode .form-select {
        background: rgba(255, 255, 255, 0.6);
        border-color: rgba(0, 0, 0, 0.15);
        color: #1a1a1a;
      }

      body.light-mode .back-link {
        color: #1a1a1a !important;
      }

      /* Color options in light mode */
      body.light-mode .color-option {
        background: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      body.light-mode .color-option:hover {
        background: rgba(255, 255, 255, 0.7);
      }

      body.light-mode .color-option[data-selected="true"] {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(46, 213, 115, 0.2) 100%);
        border-left: 3px solid #10b981;
      }

      body.light-mode .color-option.focused {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.3) 100%);
      }

      body.light-mode .color-options {
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body data-page="settings">
    <header>
      <div class="nav">
        <div class="logo" data-translate="common.slideMaker">SlideMaker</div>
        <nav class="menu" aria-label="Main">
          <a href="./Home.html" data-translate="common.home">Home</a>
          <a href="#" class="active" data-translate="common.settings">Settings</a>
        </nav>
        <div class="spacer"></div>
      </div>
    </header>

    <main class="container">
      <h1 data-translate="settings.title">Settings</h1>
      
      <!-- Two-Column Layout: Sidebar + Content -->
      <div class="settings-main-layout">
        <!-- Left Sidebar Navigation -->
        <aside class="settings-sidebar" aria-label="Settings navigation">
          <nav class="settings-tabs">
            <button class="sidebar-tab active" data-tab="profile" aria-selected="true">Profile</button>
            <button class="sidebar-tab" data-tab="account-security" aria-selected="false">Account & Security</button>
            <button class="sidebar-tab" data-tab="preferences" aria-selected="false">Preferences</button>
            <button class="sidebar-tab" data-tab="notifications" aria-selected="false">Notifications</button>
            <button class="sidebar-tab" data-tab="collaboration" aria-selected="false">Collaboration</button>
            <button class="sidebar-tab" data-tab="connected-accounts" aria-selected="false">Connected Accounts</button>
            <button class="sidebar-tab" data-tab="app-customization" aria-selected="false">App Customization</button>
            <button class="sidebar-tab" data-tab="language-theme" aria-selected="false">Language & Theme</button>
            <button class="sidebar-tab" data-tab="about" aria-selected="false">About App</button>
          </nav>
        </aside>

        <!-- Right Content Area -->
        <div class="settings-content">
          <!-- Profile Tab -->
          <div class="tab-content active" id="profile">
            <section class="settings-card" aria-labelledby="profileHeading">
              <h2 id="profileHeading">Profile</h2>
              
              <!-- Profile Picture Section -->
              <div class="profile-picture-section">
                <div class="profile-avatar-container">
                  <div class="profile-avatar-display" id="profileAvatarDisplay">
                    <img id="profileAvatarImg" src="https://i.pravatar.cc/260?img=12" alt="Profile avatar">
        </div>
        </div>
                <button type="button" class="change-photo-btn" id="changePhotoBtn">Change Photo</button>
              </div>
              
              <div class="profile-field" data-field="firstName">
                <div class="field-head">
                  <span class="field-label">First Name</span>
                  <div class="field-actions">
                    <button type="button" class="field-edit-btn">Edit</button>
                    <button type="button" class="field-save-btn hidden">Save</button>
                    <button type="button" class="field-cancel-btn hidden">Cancel</button>
        </div>
        </div>
                <div class="field-value" data-field-value="firstName">Avery</div>
                <input type="text" class="field-input hidden" data-field-input="firstName" placeholder="Enter first name" value="Avery">
              </div>

              <div class="profile-field" data-field="lastName">
                <div class="field-head">
                  <span class="field-label">Last Name</span>
                  <div class="field-actions">
                    <button type="button" class="field-edit-btn">Edit</button>
                    <button type="button" class="field-save-btn hidden">Save</button>
                    <button type="button" class="field-cancel-btn hidden">Cancel</button>
                  </div>
                </div>
                <div class="field-value" data-field-value="lastName">Johnson</div>
                <input type="text" class="field-input hidden" data-field-input="lastName" placeholder="Enter last name" value="Johnson">
              </div>

              <div class="profile-field" data-field="email" data-readonly="true">
                <div class="field-head">
                  <span class="field-label">Email Address</span>
                  <div class="field-actions">
                    <!-- Email is readonly, no edit button -->
                  </div>
                </div>
                <div class="field-value" data-field-value="email">avery.johnson@example.com</div>
                <input type="email" class="field-input hidden" data-field-input="email" placeholder="name@example.com" value="avery.johnson@example.com" readonly disabled>
              </div>

              <div class="profile-field" data-field="userID" data-readonly="true">
                <div class="field-head">
                  <span class="field-label">User ID</span>
                  <div class="field-actions">
                    <!-- UserID is readonly, no edit button -->
                  </div>
                </div>
                <div class="field-value" data-field-value="userID">-</div>
                <input type="text" class="field-input hidden" data-field-input="userID" placeholder="User ID" value="" readonly disabled>
              </div>

              <div class="profile-field" data-field="qrcode" data-readonly="true">
                <div class="field-head">
                  <span class="field-label">QR Code</span>
                  <div class="field-actions">
                    <!-- QR code is readonly, no edit button -->
                  </div>
                </div>
                <div class="field-value qr-code-container" data-field-value="qrcode">
                  <div id="userQRCode" style="display: flex; justify-content: center; align-items: center; min-height: 200px;"></div>
                </div>
              </div>

              <div class="profile-field" data-field="country">
                <div class="field-head">
                  <span class="field-label">Country</span>
                  <div class="field-actions">
                    <button type="button" class="field-edit-btn">Edit</button>
                    <button type="button" class="field-save-btn hidden">Save</button>
                    <button type="button" class="field-cancel-btn hidden">Cancel</button>
                  </div>
                </div>
                <div class="field-value" data-field-value="country">United States</div>
                <select class="field-select hidden" data-field-input="country">
                  <option value="United States" selected>United States</option>
                  <option value="Canada">Canada</option>
                  <option value="United Kingdom">United Kingdom</option>
                  <option value="Germany">Germany</option>
                  <option value="Saudi Arabia">Saudi Arabia</option>
                  <option value="Australia">Australia</option>
                </select>
              </div>

              <div class="profile-field" data-field="aboutMe">
                <div class="field-head">
                  <span class="field-label">About Me</span>
                  <div class="field-actions">
                    <button type="button" class="field-edit-btn">Edit</button>
                    <button type="button" class="field-save-btn hidden">Save</button>
                    <button type="button" class="field-cancel-btn hidden">Cancel</button>
                  </div>
                </div>
                <div class="field-value" data-field-value="aboutMe">Passionate about crafting engaging slide decks and visual storytelling that resonates with every audience.</div>
                <textarea class="field-textarea hidden" data-field-input="aboutMe" placeholder="Share a short bio">Passionate about crafting engaging slide decks and visual storytelling that resonates with every audience.</textarea>
        </div>
        </section>
          </div>

          <!-- Account & Security Tab -->
          <div class="tab-content" id="account-security">
      <section class="settings-card security-section" aria-labelledby="securityHeading">
        <h2 id="securityHeading">Account &amp; Security</h2>

        <div class="security-row">
          <div class="security-text">
            <h3>Change Password</h3>
            <p>Update your password regularly to keep your account protected. Add logic to open the modal when ready.</p>
          </div>
          <button type="button" class="security-button" aria-haspopup="dialog" aria-controls="changePasswordModal">Change Password</button>
        </div>

        <div class="security-row">
          <div class="security-text">
            <h3>Two-Factor Authentication</h3>
            <p>Add an extra layer of security to your account. Toggle will activate once logic is connected.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="twoFactorToggle" aria-label="Two-Factor Authentication">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="security-row">
          <div class="security-text">
            <h3>Delete Account</h3>
            <p>Permanently remove your account and associated data. Connect a confirmation flow before enabling.</p>
          </div>
          <button type="button" class="delete-button" aria-haspopup="dialog" aria-controls="deleteAccountModal">Delete Account</button>
        </div>
      </section>
          </div>

          <!-- Preferences Tab -->
          <div class="tab-content" id="preferences">
      <section class="settings-card preferences-section" aria-labelledby="preferencesHeading">
        <h2 id="preferencesHeading">Preferences</h2>

        <div class="preference-row">
          <div class="preference-details">
            <h3>Auto-Save Presentations</h3>
            <p>Automatically back up your presentation progress while you work.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="autoSaveToggle" aria-label="Auto-Save Presentations">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="preference-row">
          <div class="preference-details">
            <h3>Font Size</h3>
            <p>Adjust the interface typography that suits your presentation workflow best.</p>
          </div>
          <div class="font-size-options" role="group" aria-label="Font size selection">
            <button type="button" class="font-size-button is-active" data-font-size="normal" aria-pressed="true">Normal</button>
            <button type="button" class="font-size-button" data-font-size="large" aria-pressed="false">Large</button>
          </div>
        </div>

        <div class="preference-row">
          <div class="preference-details">
            <h3>Enable Animations</h3>
            <p>Control interface motion for transitions and micro-interactions.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="animationsToggle" aria-label="Enable Animations">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="preference-row" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="preference-details" style="max-width: 100%;">
            <h3>AI Assistant API Key (Optional)</h3>
            <p>Add a free Google Gemini API key for enhanced AI responses in the chatbot. <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #00c853; text-decoration: underline;">Get free API key →</a></p>
          </div>
          <div style="width: 100%; display: flex; gap: 8px; align-items: center;">
            <input 
              type="password" 
              id="geminiApiKeyInput" 
              placeholder="Enter your Gemini API key"
              style="flex: 1; padding: 10px 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #E8F5E9; font-family: 'Trebuchet MS', sans-serif; font-size: 14px; outline: none; transition: all 0.3s ease;"
            >
            <button 
              type="button" 
              id="saveApiKeyBtn"
              style="padding: 10px 20px; background: rgba(0, 200, 83, 0.2); border: 1px solid rgba(0, 200, 83, 0.4); border-radius: 8px; color: #00c853; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
              onmouseover="this.style.background='rgba(0, 200, 83, 0.3)'; this.style.borderColor='rgba(0, 200, 83, 0.6)';"
              onmouseout="this.style.background='rgba(0, 200, 83, 0.2)'; this.style.borderColor='rgba(0, 200, 83, 0.4)';"
            >
              Save
            </button>
            <button 
              type="button" 
              id="clearApiKeyBtn"
              style="padding: 10px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #E8F5E9; cursor: pointer; transition: all 0.3s ease;"
              onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(255, 255, 255, 0.2)';"
              onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)';"
            >
              Clear
            </button>
          </div>
          <div id="apiKeyStatus" style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: -8px;"></div>
        </div>
      </section>
          </div>

          <!-- Notifications Tab -->
          <div class="tab-content" id="notifications">
      <section class="settings-card notifications-section" aria-labelledby="notificationsHeading">
        <h2 id="notificationsHeading">Notifications</h2>

        <div class="notification-row">
          <div class="notification-details">
            <h3>Project Activity</h3>
            <p>Stay updated when changes happen across your shared presentations.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="notifProjectActivity" aria-label="Project Activity notifications">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="notification-row">
          <div class="notification-details">
            <h3>Comments &amp; Mentions</h3>
            <p>Get notified when teammates leave feedback or mention you.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="notifCommentsMentions" aria-label="Comments & Mentions notifications">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="notification-row">
          <div class="notification-details">
            <h3>Group Invites</h3>
            <p>Receive alerts for collaboration invites and shared workspace access.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="notifGroupInvites" aria-label="Group Invites notifications">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="notification-row">
          <div class="notification-details">
            <h3>Email Updates</h3>
            <p>Enable digest summaries and important app announcements.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="notifEmailUpdates" aria-label="Email Updates notifications">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </section>
          </div>

          <!-- Collaboration Tab -->
          <div class="tab-content" id="collaboration">
      <section class="settings-card collaboration-section" aria-labelledby="collaborationHeading">
        <h2 id="collaborationHeading">Collaboration Settings</h2>

        <div class="collaboration-row">
          <div class="collaboration-details">
            <h3>Default Sharing</h3>
            <p>Choose how new presentations are shared by default.</p>
          </div>
          <div class="collaboration-select">
            <span id="defaultSharingDisplay">Private</span>
            <select id="defaultSharingSelect" aria-label="Default sharing preference">
              <option value="Private" selected>Private</option>
              <option value="Team Only">Team Only</option>
              <option value="Public">Public</option>
            </select>
          </div>
        </div>

        <div class="collaboration-row">
          <div class="collaboration-details">
            <h3>Show Active Collaborators</h3>
            <p>Display avatars for teammates currently editing the same presentation.</p>
          </div>
          <label class="security-toggle">
            <input type="checkbox" id="collabShowActive" aria-label="Show Active Collaborators">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </section>
          </div>

          <!-- Connected Accounts Tab -->
          <div class="tab-content" id="connected-accounts">
        <section class="settings-card connections-section" aria-labelledby="connectionsHeading">
          <h2 id="connectionsHeading">Connected Accounts</h2>

          <div class="connection-item">
            <div class="connection-details">
              <h3>Connect Google Drive</h3>
              <p>Link your Google Drive to import slides and sync assets.</p>
            </div>
            <button type="button" class="connection-button" id="connectGoogleDrive">Connect</button>
          </div>

          <div class="connection-item">
            <div class="connection-details">
              <h3>Connect GitHub</h3>
              <p>Sync project assets or store presentations in repositories.</p>
            </div>
            <button type="button" class="connection-button" id="connectGitHub">Connect</button>
          </div>

          <div class="connection-item">
            <div class="connection-details">
              <h3>Connect Dropbox</h3>
              <p>Enable Dropbox backups and quick access to shared folders.</p>
            </div>
            <button type="button" class="connection-button" id="connectDropbox">Connect</button>
          </div>
        </section>
          </div>

          <!-- App Customization Tab -->
          <div class="tab-content" id="app-customization">
        <section class="settings-card app-customization-section" aria-labelledby="customizationHeading">
          <h2 id="customizationHeading">App Customization</h2>

          <div class="customization-group">
            <div class="customization-details">
              <h3>Rounded Corners</h3>
              <p>Choose whether interface surfaces use softened, rounded corners across the app.</p>
            </div>
            <label class="security-toggle">
              <input type="checkbox" id="roundedCornersToggle" aria-label="Rounded Corners">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="customization-group">
            <div class="customization-details">
              <h3>Glass Effect</h3>
              <p>Preview a frosted glass aesthetic for cards and surfaces.</p>
            </div>
            <label class="security-toggle">
              <input type="checkbox" id="glassEffectToggle" aria-label="Glass Effect">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="customization-group">
            <div class="customization-details">
              <h3>UI Density</h3>
              <p>Adjust spacing for controls and content layouts to match your working style.</p>
            </div>
            <div class="density-select">
              <span id="uiDensityDisplay">Comfortable</span>
              <select id="uiDensitySelect" aria-label="UI density selection">
                <option value="compact">Compact</option>
                <option value="comfortable" selected>Comfortable</option>
                <option value="spacious">Spacious</option>
              </select>
            </div>
          </div>
        </section>
      </div>

          <!-- Language & Theme Tab -->
          <div class="tab-content" id="language-theme">
        <div class="settings-card form-settings-card">
        <div class="form-group">
          <label class="form-label" for="backgroundSelector" data-translate="settings.backgroundColor">Background Color</label>
          <div class="color-options" id="backgroundSelector">
            <div class="color-option" data-color="#ffffff">
                <div class="theme-preview">
                <img src="./CURSOR-Project/thems-mods/light.jpeg" alt="light">
                </div>
                <div class="theme-meta">
              <span class="color-label" data-translate="settings.light">Light</span>
                  <span class="check-icon"></span>
                </div>
            </div>
            <div class="color-option" data-color="#000000">
                <div class="theme-preview">
                <img src="./CURSOR-Project/thems-mods/dark.jpeg" alt="dark">
                </div>
                <div class="theme-meta">
              <span class="color-label" data-translate="settings.dark">Dark</span>
                  <span class="check-icon"></span>
                </div>
              </div>
              <div class="color-option" data-color="#0b3d2e" data-selected="true">
                <div class="theme-preview">
                <img src="./CURSOR-Project/thems-mods/defult.jpeg" alt="defult">
                </div>
                <div class="theme-meta">
                  <span class="color-label">System Default</span>
                  <span class="check-icon">✓</span>
                </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="languageSelector" data-translate="settings.language">Language</label>
          <div class="color-options" id="languageSelector">
            <div class="color-option" data-lang="en" data-selected="true">
              <span class="check-icon">✓</span>
              <span class="color-label" data-translate="settings.english">English</span>
            </div>
            <div class="color-option" data-lang="ar">
              <span class="check-icon"></span>
              <span class="color-label" data-translate="settings.arabic">Arabic</span>
            </div>
            </div>
          </div>
        </div>
      </div>

          <!-- About App Tab -->
          <div class="tab-content" id="about">
      <div class="settings-card" id="aboutCard">
        <div class="form-group">
          <label class="form-label" data-translate="settings.aboutTitle">About App</label>
          <ul class="about-list">
            <li>
              <span data-translate="settings.version">Version</span>:
              <strong id="appVersion">1.0.0</strong>
            </li>
            <li>
              <span data-translate="settings.developer">Developed by</span>:
              <strong id="devName">Mohammed Al-Otaibi</strong>
            </li>
            <li>
              <span data-translate="settings.contact">Contact</span>:
              <a id="contactEmail" href="mailto:your-email@example.com">your-email@example.com</a>
            </li>
            <li>
              <a href="#" id="privacyPolicyLink" data-translate="settings.privacyPolicy">Privacy Policy</a>
            </li>
          </ul>
          </div>
        </div>
          </div>
        </div>
      </div>

      <div class="modal-overlay" id="changePasswordModal" role="dialog" aria-modal="true" aria-labelledby="changePasswordHeading" aria-hidden="true">
        <div class="modal-card">
          <h3 id="changePasswordHeading">Change Password</h3>
          <form class="modal-form" id="changePasswordForm">
            <div class="modal-form-group">
              <label class="modal-form-label" for="oldPassword">Old Password</label>
              <input type="password" class="modal-form-input" id="oldPassword" name="oldPassword" required>
              <div class="modal-form-error" id="oldPasswordError"></div>
            </div>
            <div class="modal-form-group">
              <label class="modal-form-label" for="newPassword">New Password</label>
              <input type="password" class="modal-form-input" id="newPassword" name="newPassword" required>
              <div class="modal-form-error" id="newPasswordError"></div>
            </div>
            <div class="modal-form-group">
              <label class="modal-form-label" for="confirmPassword">Confirm New Password</label>
              <input type="password" class="modal-form-input" id="confirmPassword" name="confirmPassword" required>
              <div class="modal-form-error" id="confirmPasswordError"></div>
            </div>
          <div class="modal-actions">
              <button type="button" class="modal-close" id="changePasswordCancel">Cancel</button>
              <button type="submit" class="modal-confirm">Save New Password</button>
          </div>
          </form>
        </div>
      </div>

      <div class="modal-overlay" id="deleteAccountModal" role="dialog" aria-modal="true" aria-labelledby="deleteAccountHeading" aria-hidden="true">
        <div class="modal-card">
          <h3 id="deleteAccountHeading">Delete Account</h3>
          <p>Are you sure? This cannot be undone.</p>
          <div class="modal-actions">
            <button type="button" class="modal-close" id="deleteAccountCancel">Cancel</button>
            <button type="button" class="modal-confirm" id="deleteAccountConfirm">Yes, Delete</button>
          </div>
        </div>
      </div>

      <!-- Avatar Modal -->
      <div class="avatar-modal-overlay" id="avatarModal" role="dialog" aria-modal="true" aria-labelledby="avatarModalHeading" aria-hidden="true">
        <div class="avatar-modal-card">
          <h3 id="avatarModalHeading">Change Profile Photo</h3>
          
          <div class="avatar-upload-section">
            <label for="avatarFileInput" class="avatar-upload-label">
              📤 Upload Image (JPG, PNG, WEBP)
            </label>
            <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;">
            <div class="avatar-preview" id="avatarPreview">
              <img id="avatarPreviewImg" src="https://api.dicebear.com/7.x/lorelei/svg?seed=Default&backgroundColor=e0e7ff" alt="Avatar preview">
            </div>
          </div>

          <div class="avatar-presets-section">
            <h4 class="avatar-presets-title">Or choose a preset avatar:</h4>
            <div class="avatar-presets-grid" id="avatarPresetsGrid">
              <div class="avatar-preset-item" data-preset="1">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Alex&backgroundColor=e0e7ff" alt="Avatar preset 1">
              </div>
              <div class="avatar-preset-item" data-preset="2">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Sam&backgroundColor=c7d2fe" alt="Avatar preset 2">
              </div>
              <div class="avatar-preset-item" data-preset="3">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Jordan&backgroundColor=ffd5dc" alt="Avatar preset 3">
              </div>
              <div class="avatar-preset-item" data-preset="4">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Taylor&backgroundColor=ffdfbf" alt="Avatar preset 4">
              </div>
              <div class="avatar-preset-item" data-preset="5">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Casey&backgroundColor=d1f4e0" alt="Avatar preset 5">
              </div>
              <div class="avatar-preset-item" data-preset="6">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Riley&backgroundColor=fce7f3" alt="Avatar preset 6">
              </div>
              <div class="avatar-preset-item" data-preset="7">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Avery&backgroundColor=e0e7ff" alt="Avatar preset 7">
              </div>
              <div class="avatar-preset-item" data-preset="8">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Morgan&backgroundColor=ffe4e6" alt="Avatar preset 8">
              </div>
              <div class="avatar-preset-item" data-preset="9">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Quinn&backgroundColor=fff4e6" alt="Avatar preset 9">
              </div>
              <div class="avatar-preset-item" data-preset="10">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Dakota&backgroundColor=e0f2fe" alt="Avatar preset 10">
              </div>
              <div class="avatar-preset-item" data-preset="11">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Sage&backgroundColor=f3e8ff" alt="Avatar preset 11">
              </div>
              <div class="avatar-preset-item" data-preset="12">
                <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Parker&backgroundColor=fef3c7" alt="Avatar preset 12">
              </div>
            </div>
          </div>

          <div class="avatar-modal-actions">
            <button type="button" class="avatar-modal-cancel" id="avatarModalCancel">Cancel</button>
            <button type="button" class="avatar-modal-save" id="avatarModalSave">Save</button>
          </div>
        </div>
      </div>

      <!-- Toast Container -->
      <div class="toast" id="toast"></div>
 
      <a href="./Home.html" class="back-link" data-translate="settings.backToHome">← Back to Home</a>
    </main>

    <script>
      // Route Protection - Check authentication on page load
      (function() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        const isGuest = localStorage.getItem('guest') === 'true';
        
        // If not authenticated and not a guest, redirect to welcome page
        if (!currentUser && !isGuest) {
          window.location.href = './index.html';
          return;
        }
      })();

      // About Modal Functions
      function openAboutModal() {
        const modal = document.getElementById('aboutModal');
        if (modal) {
          modal.classList.add('is-visible');
          modal.setAttribute('aria-hidden', 'false');
          // Prevent body scroll when modal is open
          document.body.style.overflow = 'hidden';
        }
      }

      function closeAboutModal() {
        const modal = document.getElementById('aboutModal');
        if (modal) {
          modal.classList.remove('is-visible');
          modal.setAttribute('aria-hidden', 'true');
          // Restore body scroll
          document.body.style.overflow = '';
        }
      }

      // Close modal on outside click
      document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('aboutModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeAboutModal();
            }
          });
        }
      });

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('aboutModal');
          if (modal && modal.classList.contains('is-visible')) {
            closeAboutModal();
          }
        }
      });

      // Tab Switching Logic
      (function() {
        const tabs = document.querySelectorAll('.sidebar-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
          // Hide all tab contents
          tabContents.forEach(content => {
            content.classList.remove('active');
          });

          // Remove active class from all tabs
          tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
          });

          // Show selected tab content
          const selectedContent = document.getElementById(tabId);
          if (selectedContent) {
            selectedContent.classList.add('active');
          }

          // Activate selected tab
          const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);
          if (selectedTab) {
            selectedTab.classList.add('active');
            selectedTab.setAttribute('aria-selected', 'true');
          }
        }

        // Add click handlers to all tabs
        tabs.forEach(tab => {
          tab.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = tab.getAttribute('data-tab');
            
            // Special handling for About tab - open modal instead
            if (tabId === 'about') {
              openAboutModal();
              return;
            }
            
            if (tabId) {
              switchTab(tabId);
            }
          });
        });

        // Initialize: show first tab (Profile) by default
        const defaultTab = document.querySelector('.sidebar-tab.active');
        if (defaultTab) {
          const defaultTabId = defaultTab.getAttribute('data-tab');
          if (defaultTabId) {
            switchTab(defaultTabId);
          }
        }
      })();

      // Profile Field Editing Logic
      (function() {
        const STORAGE_KEY = 'userProfileData';
        
        // Load profile data from currentUser (logged-in user) or use defaults
        function loadProfileData() {
          // Get current logged-in user
          const currentUserStr = localStorage.getItem('currentUser');
          let currentUser = null;
          
          if (currentUserStr) {
            try {
              currentUser = JSON.parse(currentUserStr);
            } catch (e) {
              console.error('Error parsing currentUser:', e);
            }
          }
          
          // If we have a logged-in user, use their data
          if (currentUser) {
            // Also check Database for additional fields
            let dbUser = null;
            if (typeof Database !== 'undefined') {
              // Try to find user by userID first
              if (currentUser.userID) {
                dbUser = Database.getUserByID(currentUser.userID);
              }
              // If not found by userID, try by email
              if (!dbUser && currentUser.email) {
                dbUser = Database.getUserByEmail(currentUser.email);
              }
            }
            
            // Get or generate userID
            let userID = currentUser.userID;
            console.log('Current userID from currentUser:', userID);
            
            // If no userID exists or userID is not a 5-digit number, generate one and save it immediately
            if (!userID || userID === '' || userID === null || userID === undefined || !/^\d{5}$/.test(userID)) {
              console.log('No valid 5-digit userID found, generating new one...');
              
              // Generate unique 5-digit userID
              function generateUnique5DigitID() {
                let newUserID;
                let attempts = 0;
                const maxAttempts = 100;
                
                // Check existing userIDs in Database
                const existingUserIDs = new Set();
                if (typeof Database !== 'undefined') {
                  const allUsers = Database.getAllUsers();
                  allUsers.forEach(user => {
                    if (user.userID && /^\d{5}$/.test(user.userID)) {
                      existingUserIDs.add(user.userID);
                    }
                  });
                }
                
                // Also check old users array
                const oldUsers = JSON.parse(localStorage.getItem("users") || "[]");
                oldUsers.forEach(user => {
                  if (user.userID && /^\d{5}$/.test(user.userID)) {
                    existingUserIDs.add(user.userID);
                  }
                });
                
                // Generate random 5-digit number (10000 to 99999)
                do {
                  newUserID = String(Math.floor(Math.random() * 90000) + 10000);
                  attempts++;
                  if (attempts > maxAttempts) {
                    // Fallback: use timestamp-based ID if too many collisions
                    newUserID = String(Date.now() % 90000 + 10000);
                    break;
                  }
                } while (existingUserIDs.has(newUserID));
                
                return newUserID;
              }
              
              userID = generateUnique5DigitID();
              console.log('Generated new 5-digit userID:', userID);
              
              // Update currentUser with new userID
              currentUser.userID = userID;
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              console.log('Saved userID to currentUser');
              
              // Also update Database if user exists there
              if (typeof Database !== 'undefined' && dbUser) {
                // Use the dbUser's current userID to find and update it
                const oldUserID = dbUser.userID;
                Database.updateUser(oldUserID, { userID: userID });
                console.log('Updated Database user with new UUID');
              } else if (typeof Database !== 'undefined' && currentUser.email) {
                // If user exists in Database but we couldn't find them, try to update by email
                const userByEmail = Database.getUserByEmail(currentUser.email);
                if (userByEmail) {
                  const oldUserID = userByEmail.userID;
                  Database.updateUser(oldUserID, { userID: userID });
                  console.log('Updated Database user (found by email) with new UUID');
                }
              }
            }
            
            console.log('Final userID to use:', userID);
            
            // Extract firstName and lastName
            let firstName = currentUser.firstName;
            let lastName = currentUser.lastName;
            
            // If not in currentUser, try to get from Database
            if (!firstName && dbUser && dbUser.firstName) {
              firstName = dbUser.firstName;
            }
            if (!lastName && dbUser && dbUser.lastName) {
              lastName = dbUser.lastName;
            }
            
            // If still not found, try to extract from name/fullName
            if (!firstName || !lastName) {
              const nameToSplit = currentUser.name || currentUser.fullName || currentUser.username || '';
              if (nameToSplit) {
                const nameParts = nameToSplit.trim().split(' ');
                if (!firstName && nameParts.length > 0) {
                  firstName = nameParts[0];
                }
                if (!lastName && nameParts.length > 1) {
                  lastName = nameParts.slice(1).join(' ');
                }
              }
            }
            
            // Merge currentUser with Database data
            return {
              firstName: firstName || '',
              lastName: lastName || '',
              email: currentUser.email || '',
              userID: userID || '',
              country: 'United States', // Default, can be stored separately if needed
              aboutMe: 'Passionate about crafting engaging slide decks and visual storytelling that resonates with every audience.' // Default
            };
          }
          
          // Default values (fallback) - user is not logged in
          return {
            firstName: '',
            lastName: '',
            email: '',
            userID: '',
            country: 'United States',
            aboutMe: 'Passionate about crafting engaging slide decks and visual storytelling that resonates with every audience.'
          };
        }

        // Save profile data - update currentUser and Database
        function saveProfileData(data) {
          // Update currentUser in localStorage
          const currentUserStr = localStorage.getItem('currentUser');
          if (currentUserStr) {
            try {
              const currentUser = JSON.parse(currentUserStr);
              currentUser.firstName = data.firstName;
              currentUser.lastName = data.lastName;
              currentUser.name = `${data.firstName} ${data.lastName}`.trim();
              currentUser.fullName = currentUser.name;
              currentUser.username = currentUser.name;
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              
              // Also update Database if available
              if (typeof Database !== 'undefined' && currentUser.userID) {
                Database.updateUser(currentUser.userID, {
                  firstName: data.firstName,
                  lastName: data.lastName,
                  fullName: `${data.firstName} ${data.lastName}`.trim()
                });
              }
            } catch (e) {
              console.error('Error updating currentUser:', e);
            }
          }
          
          // Also save to separate storage for backward compatibility
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ============================================
        // COMPLETELY NEW QR CODE GENERATOR - FRESH START
        // ============================================
        
        // OLD FUNCTIONS REMOVED - Now using qrcodejs library (DOM-based)
        
        // Generate QR code using qrcodejs library (DOM-based, not canvas)
        function generateQRCode(userID) {
          console.log('[QR] ===== QR CODE GENERATION START =====');
          console.log('[QR] UserID received:', userID);
          console.log('[QR] UserID type:', typeof userID);
          
          // Check if qrcodejs library is loaded
          if (typeof QRCode === 'undefined') {
            console.error('[QR ERROR] QRCode library (qrcodejs) not loaded!');
            console.error('[QR ERROR] Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('qr')));
            return false;
          }
          
          console.log('[QR] ✓ QRCode library (qrcodejs) is loaded');
          console.log('[QR] QRCode constructor:', typeof QRCode);
          
          // Validate userID
          if (!userID || userID === '' || userID === '-' || userID === null || userID === undefined) {
            console.error('[QR ERROR] No valid userID provided');
            return false;
          }
          
          // Extract digits from userID and format with # prefix
          let userIDDigits = String(userID).trim();
          const digitsMatch = userIDDigits.match(/\d{5}/);
          if (digitsMatch) {
            userIDDigits = digitsMatch[0];
          } else if (/^\d{5}$/.test(userIDDigits)) {
            // Already 5 digits
          } else {
            console.error('[QR ERROR] Invalid userID format:', userID);
            return false;
          }
          
          const qrText = '#' + userIDDigits;
          console.log('[QR] QR code text will be:', qrText);
          
          // Get the container div (not canvas)
          const qrContainer = document.getElementById('userQRCode');
          if (!qrContainer) {
            console.error('[QR ERROR] QR container div (#userQRCode) not found!');
            return false;
          }
          
          console.log('[QR] QR container found:', qrContainer.id);
          console.log('[QR] Container element:', qrContainer);
          
          // Clear any existing QR code
          qrContainer.innerHTML = '';
          console.log('[QR] Container cleared');
          
          // Generate QR code using qrcodejs
          try {
            console.log('[QR] Creating QRCode instance...');
            console.log('[QR] Text:', qrText);
            console.log('[QR] Width: 180, Height: 180');
            
            const qr = new QRCode(qrContainer, {
              text: qrText,
              width: 180,
              height: 180
            });
            
            console.log('[QR] ✓ QRCode instance created successfully');
            console.log('[QR] QRCode object:', qr);
            
            // Verify QR code was generated by checking if container has content
            setTimeout(() => {
              if (qrContainer.innerHTML && qrContainer.innerHTML.trim() !== '') {
                console.log('[QR OK] QR code rendered successfully!');
                console.log('[QR] Container now has content');
                qrContainer.style.display = 'flex';
                qrContainer.style.visibility = 'visible';
                qrContainer.style.opacity = '1';
              } else {
                console.error('[QR ERROR] Container is still empty after QR generation');
              }
            }, 100);
            
            return true;
          } catch (e) {
            console.error('[QR ERROR] Exception during QR code generation:', e);
            console.error('[QR ERROR] Exception details:', e.message, e.stack);
            return false;
          }
        }

        // Initialize profile fields with saved data
        function initializeProfileFields() {
          console.log('Initializing profile fields...');
          const profileData = loadProfileData();
          console.log('Loaded profile data:', profileData);
          
          // Update all field values
          Object.keys(profileData).forEach(fieldName => {
            const valueElement = document.querySelector(`[data-field-value="${fieldName}"]`);
            const inputElement = document.querySelector(`[data-field-input="${fieldName}"]`);
            
            if (fieldName === 'qrcode') {
              // Handle QR code separately - skip for now, will handle after all fields are set
              return;
            }
            
            if (valueElement) {
              let value = profileData[fieldName] || '-';
              
              // Special handling for userID - always display with hashtag
              if (fieldName === 'userID') {
                const userIDValue = String(value).trim();
                // If userID is just digits, add # prefix for display
                if (userIDValue && userIDValue !== '-' && /^\d{5}$/.test(userIDValue)) {
                  value = '#' + userIDValue;
                } else if (userIDValue && !userIDValue.startsWith('#') && userIDValue !== '-') {
                  // Extract digits and format
                  const digits = userIDValue.match(/\d+/);
                  if (digits && digits[0].length === 5) {
                    value = '#' + digits[0];
                  }
                }
                // If already has #, keep it
              }
              
              valueElement.textContent = value;
              console.log(`Set ${fieldName} value:`, value);
            }
            
            if (inputElement) {
              if (inputElement.tagName === 'SELECT') {
                inputElement.value = profileData[fieldName] || '';
                // Update selected option
                Array.from(inputElement.options).forEach(option => {
                  option.selected = option.value === profileData[fieldName];
                });
              } else {
                inputElement.value = profileData[fieldName] || '';
              }
            }
          });
          
          // Generate QR code after all fields are set and DOM is ready
          // Get userID (can be digits only or with #)
          const userID = profileData.userID;
          
          // Validate userID - accept #74169 or 74169 format
          const isValidUserID = userID && 
                                userID !== '' && 
                                userID !== '-' &&
                                (/^#\d{5}$/.test(String(userID)) || /^\d{5}$/.test(String(userID)));
          
          if (isValidUserID) {
            console.log('[QR] Scheduling QR code generation for userID:', userID);
            
            // Function to attempt QR code generation with retries
            const attemptQRGeneration = (delay) => {
              setTimeout(() => {
                console.log(`[QR] Attempt ${delay}ms - Checking prerequisites...`);
                
                // Check QR container div exists
                const qrContainer = document.getElementById('userQRCode');
                if (!qrContainer) {
                  console.warn(`[QR] QR container not found at ${delay}ms, retrying...`);
                  if (delay < 3000) {
                    attemptQRGeneration(delay + 500);
                  }
                  return;
                }
                
                // Check if qrcodejs library is available
                if (typeof QRCode === 'undefined') {
                  console.warn(`[QR] QRCode library (qrcodejs) not loaded at ${delay}ms, retrying...`);
                  if (delay < 3000) {
                    attemptQRGeneration(delay + 500);
                  }
                  return;
                }
                
                console.log(`[QR] All prerequisites met at ${delay}ms, generating QR code...`);
                generateQRCode(userID);
              }, delay);
            };
            
            // Try multiple times with increasing delays
            attemptQRGeneration(300);   // First attempt
            attemptQRGeneration(600);   // Second attempt
            attemptQRGeneration(1000);  // Third attempt
            attemptQRGeneration(2000);  // Fourth attempt
          } else {
            console.warn('[QR] No valid userID available. userID:', userID);
          }
        }

          // Enter edit mode for a field
          function enterEditMode(fieldElement) {
            // Don't allow editing readonly fields
            if (fieldElement && fieldElement.getAttribute('data-readonly') === 'true') {
              return;
            }
            
            const fieldName = fieldElement.getAttribute('data-field');
            const valueElement = fieldElement.querySelector(`[data-field-value="${fieldName}"]`);
            const inputElement = fieldElement.querySelector(`[data-field-input="${fieldName}"]`);
            const editBtn = fieldElement.querySelector('.field-edit-btn');
            const saveBtn = fieldElement.querySelector('.field-save-btn');
            const cancelBtn = fieldElement.querySelector('.field-cancel-btn');
            
            // Safety check - if no edit button, field is readonly
            if (!editBtn) {
              return;
            }

          // Store original value for cancel
          const originalValue = inputElement.tagName === 'SELECT' 
            ? inputElement.value 
            : inputElement.value;

          // Hide value, show input
          valueElement.classList.add('hidden');
          inputElement.classList.remove('hidden');
          
          // Hide edit button, show save/cancel
          editBtn.classList.add('hidden');
          saveBtn.classList.remove('hidden');
          cancelBtn.classList.remove('hidden');

          // Focus on input
          inputElement.focus();
          if (inputElement.tagName === 'INPUT' || inputElement.tagName === 'TEXTAREA') {
            inputElement.select();
          }

          // Save handler
          const saveHandler = () => {
            const newValue = inputElement.tagName === 'SELECT' 
              ? inputElement.value 
              : inputElement.value.trim();

            // Update value display
            valueElement.textContent = newValue;
            
            // Update localStorage
            const profileData = loadProfileData();
            profileData[fieldName] = newValue;
            saveProfileData(profileData);

            // Exit edit mode
            exitEditMode(fieldElement);
          };

          // Cancel handler
          const cancelHandler = () => {
            // Restore original value
            if (inputElement.tagName === 'SELECT') {
              inputElement.value = originalValue;
              Array.from(inputElement.options).forEach(option => {
                option.selected = option.value === originalValue;
              });
            } else {
              inputElement.value = originalValue;
            }
            
            // Exit edit mode
            exitEditMode(fieldElement);
          };

          // Remove old listeners and add new ones
          saveBtn.replaceWith(saveBtn.cloneNode(true));
          cancelBtn.replaceWith(cancelBtn.cloneNode(true));
          
          const newSaveBtn = fieldElement.querySelector('.field-save-btn');
          const newCancelBtn = fieldElement.querySelector('.field-cancel-btn');
          
          newSaveBtn.addEventListener('click', saveHandler);
          newCancelBtn.addEventListener('click', cancelHandler);

          // Handle Enter key to save, Escape to cancel
          const keyHandler = (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey || inputElement.tagName !== 'TEXTAREA')) {
              if (inputElement.tagName !== 'TEXTAREA' || e.ctrlKey || e.metaKey) {
                e.preventDefault();
                saveHandler();
              }
            } else if (e.key === 'Escape') {
              e.preventDefault();
              cancelHandler();
            }
          };

          inputElement.addEventListener('keydown', keyHandler);
        }

        // Exit edit mode for a field
        function exitEditMode(fieldElement) {
          const fieldName = fieldElement.getAttribute('data-field');
          const valueElement = fieldElement.querySelector(`[data-field-value="${fieldName}"]`);
          const inputElement = fieldElement.querySelector(`[data-field-input="${fieldName}"]`);
          const editBtn = fieldElement.querySelector('.field-edit-btn');
          const saveBtn = fieldElement.querySelector('.field-save-btn');
          const cancelBtn = fieldElement.querySelector('.field-cancel-btn');

          // Show value, hide input
          valueElement.classList.remove('hidden');
          inputElement.classList.add('hidden');
          
          // Show edit button, hide save/cancel
          editBtn.classList.remove('hidden');
          saveBtn.classList.add('hidden');
          cancelBtn.classList.add('hidden');
        }

        // Initialize on page load - wait for DOM and Database to be ready
        function initProfile() {
          // Wait a bit for Database module to load if needed
          if (typeof Database === 'undefined') {
            setTimeout(initProfile, 100);
            return;
          }
          
          initializeProfileFields();
        }
        
        // Run initialization when DOM is ready
        function runInitialization() {
          console.log('[Profile] Running initialization, readyState:', document.readyState);
          initProfile();
          
          // Ensure QR code is generated after everything loads
          setTimeout(() => {
            console.log('[Profile] Final QR code check...');
            const profileData = loadProfileData();
            const userID = profileData.userID;
            if (userID) {
              // Format userID with # prefix
              let userIDString = String(userID).trim();
              if (/^\d{5}$/.test(userIDString)) {
                userIDString = '#' + userIDString;
              } else if (!userIDString.startsWith('#')) {
                const digits = userIDString.match(/\d{5}/);
                if (digits) {
                  userIDString = '#' + digits[0];
                }
              }
              
              const qrContainer = document.getElementById('userQRCode');
              if (qrContainer && typeof QRCode !== 'undefined') {
                console.log('[Profile] Final attempt to generate QR code for:', userIDString);
                generateQRCode(userID);
              }
            }
          }, 2500);
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', runInitialization);
        } else {
          // DOM is already ready
          runInitialization();
        }
        
        // Also run on window load as backup
        window.addEventListener('load', () => {
          console.log('[Profile] Window loaded, final QR code check...');
          setTimeout(() => {
            const profileData = loadProfileData();
            const userID = profileData.userID;
            if (userID) {
              const qrContainer = document.getElementById('userQRCode');
              if (qrContainer && typeof QRCode !== 'undefined') {
                // Check if QR code container is empty
                if (qrContainer.innerHTML.trim() === '') {
                  console.log('[Profile] QR container is empty, generating QR code for userID:', userID);
                  generateQRCode(userID);
                } else {
                  console.log('[Profile] QR code already exists');
                }
              }
            }
          }, 1000);
        });

        // Add click handlers to all edit buttons (skip readonly fields)
        // Use event delegation to handle dynamically loaded buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('field-edit-btn')) {
            const fieldElement = e.target.closest('.profile-field');
            // Skip readonly fields
            if (fieldElement && fieldElement.getAttribute('data-readonly') === 'true') {
              return;
            }
            enterEditMode(fieldElement);
          }
        });
      })();

      // Profile Avatar Functionality
      (function() {
        const AVATAR_STORAGE_KEY = 'profile_avatar';
        const DEFAULT_AVATAR = 'https://api.dicebear.com/7.x/lorelei/svg?seed=Default&backgroundColor=e0e7ff';

        // Reuse toast function
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // State variables
        let uploadedImageData = null;
        let selectedPresetUrl = null;

        // Modal helper functions
        function openAvatarModal() {
          const modal = document.getElementById('avatarModal');
          if (modal) {
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            // Reset state
            uploadedImageData = null;
            selectedPresetUrl = null;
            // Load current avatar into preview
            loadAvatarToPreview();
          }
        }

        function closeAvatarModal() {
          const modal = document.getElementById('avatarModal');
          if (modal) {
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            // Reset state
            uploadedImageData = null;
            selectedPresetUrl = null;
            // Reset preview to current saved avatar
            loadAvatarToPreview();
            // Clear file input
            const fileInput = document.getElementById('avatarFileInput');
            if (fileInput) fileInput.value = '';
            // Clear preset selection
            document.querySelectorAll('.avatar-preset-item').forEach(item => {
              item.classList.remove('selected');
            });
          }
        }

        // Load avatar from localStorage
        function loadAvatar() {
          const saved = localStorage.getItem(AVATAR_STORAGE_KEY);
          return saved || DEFAULT_AVATAR;
        }

        // Save avatar to localStorage
        function saveAvatar(avatarData) {
          localStorage.setItem(AVATAR_STORAGE_KEY, avatarData);
        }

        // Update avatar display everywhere
        function updateAvatarDisplay(avatarSrc) {
          const profileAvatarImg = document.getElementById('profileAvatarImg');
          if (profileAvatarImg) {
            profileAvatarImg.src = avatarSrc;
          }
          // Update preview in modal
          const previewImg = document.getElementById('avatarPreviewImg');
          if (previewImg) {
            previewImg.src = avatarSrc;
          }
        }

        // Load avatar to preview in modal
        function loadAvatarToPreview() {
          const currentAvatar = loadAvatar();
          updateAvatarDisplay(currentAvatar);
        }

        // Initialize avatar on page load
        function initializeAvatar() {
          const avatar = loadAvatar();
          updateAvatarDisplay(avatar);
        }

        // Convert file to base64
        function fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        // Initialize on page load
        initializeAvatar();

        // Open modal button
        const changePhotoBtn = document.getElementById('changePhotoBtn');
        if (changePhotoBtn) {
          changePhotoBtn.addEventListener('click', openAvatarModal);
        }

        // Open modal when clicking avatar
        const profileAvatarDisplay = document.getElementById('profileAvatarDisplay');
        if (profileAvatarDisplay) {
          profileAvatarDisplay.addEventListener('click', openAvatarModal);
        }

        // Close modal on cancel
        const avatarModalCancel = document.getElementById('avatarModalCancel');
        if (avatarModalCancel) {
          avatarModalCancel.addEventListener('click', closeAvatarModal);
        }

        // Close modal on overlay click
        const avatarModal = document.getElementById('avatarModal');
        if (avatarModal) {
          avatarModal.addEventListener('click', (e) => {
            if (e.target === avatarModal) {
              closeAvatarModal();
            }
          });
        }

        // File upload handler
        const avatarFileInput = document.getElementById('avatarFileInput');

        if (avatarFileInput) {
          avatarFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
              showToast('Please upload a JPG, PNG, or WEBP image.', 'error');
              return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showToast('Image size must be less than 5MB.', 'error');
              return;
            }

            try {
              // Convert to base64
              const base64 = await fileToBase64(file);
              uploadedImageData = base64;
              
              // Update preview
              const previewImg = document.getElementById('avatarPreviewImg');
              if (previewImg) {
                previewImg.src = base64;
              }

              // Clear preset selection
              document.querySelectorAll('.avatar-preset-item').forEach(item => {
                item.classList.remove('selected');
              });
            } catch (error) {
              console.error('Error reading file:', error);
              showToast('Error reading image file.', 'error');
            }
          });
        }

        // Preset avatar selection
        const presetItems = document.querySelectorAll('.avatar-preset-item');

        presetItems.forEach(item => {
          item.addEventListener('click', () => {
            // Remove selection from all
            presetItems.forEach(i => i.classList.remove('selected'));
            // Add selection to clicked item
            item.classList.add('selected');
            
            // Get preset image URL
            const presetImg = item.querySelector('img');
            if (presetImg) {
              selectedPresetUrl = presetImg.src;
              // Update preview
              const previewImg = document.getElementById('avatarPreviewImg');
              if (previewImg) {
                previewImg.src = selectedPresetUrl;
              }
              // Clear uploaded file
              uploadedImageData = null;
              if (avatarFileInput) avatarFileInput.value = '';
            }
          });
        });

        // Save button handler
        const avatarModalSave = document.getElementById('avatarModalSave');
        if (avatarModalSave) {
          avatarModalSave.addEventListener('click', () => {
            let avatarToSave = null;

            // Priority: uploaded image > selected preset > current avatar
            if (uploadedImageData) {
              avatarToSave = uploadedImageData;
            } else if (selectedPresetUrl) {
              avatarToSave = selectedPresetUrl;
            } else {
              // No change made
              closeAvatarModal();
              return;
            }

            // Save to localStorage
            saveAvatar(avatarToSave);
            
            // Update display
            updateAvatarDisplay(avatarToSave);

            // Show toast
            showToast('Profile photo updated successfully.', 'success');

            // Close modal
            closeAvatarModal();

            // Log to console
            console.log('Profile Avatar Updated:', {
              type: uploadedImageData ? 'uploaded' : 'preset',
              timestamp: new Date().toISOString()
            });
          });
        }
      })();

      // Account & Security Functionality
      (function() {
        // Toast notification helper
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = `toast ${type} show`;
          
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              toast.className = 'toast';
            }, 300);
          }, 3000);
        }

        // Modal helper functions
        function openModal(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
          }
        }

        function closeModal(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
          }
        }

        // 1. Change Password Modal
        const changePasswordBtn = document.querySelector('.security-button[aria-controls="changePasswordModal"]');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const changePasswordCancel = document.getElementById('changePasswordCancel');

        if (changePasswordBtn) {
          changePasswordBtn.addEventListener('click', () => {
            openModal('changePasswordModal');
          });
        }

        if (changePasswordCancel) {
          changePasswordCancel.addEventListener('click', () => {
            closeModal('changePasswordModal');
            changePasswordForm.reset();
            // Clear errors
            document.querySelectorAll('.modal-form-error').forEach(error => {
              error.classList.remove('show');
              error.textContent = '';
            });
          });
        }

        // Close modal on overlay click
        if (changePasswordModal) {
          changePasswordModal.addEventListener('click', (e) => {
            if (e.target === changePasswordModal) {
              closeModal('changePasswordModal');
              changePasswordForm.reset();
              document.querySelectorAll('.modal-form-error').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
              });
            }
          });
        }

        // Form validation and submission
        if (changePasswordForm) {
          changePasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            // Clear previous errors
            document.querySelectorAll('.modal-form-error').forEach(error => {
              error.classList.remove('show');
              error.textContent = '';
            });

            let isValid = true;

            // Validate all fields are filled
            if (!oldPassword) {
              const errorEl = document.getElementById('oldPasswordError');
              errorEl.textContent = 'Old password is required';
              errorEl.classList.add('show');
              isValid = false;
            }

            if (!newPassword) {
              const errorEl = document.getElementById('newPasswordError');
              errorEl.textContent = 'New password is required';
              errorEl.classList.add('show');
              isValid = false;
            }

            if (!confirmPassword) {
              const errorEl = document.getElementById('confirmPasswordError');
              errorEl.textContent = 'Please confirm your new password';
              errorEl.classList.add('show');
              isValid = false;
            }

            // Validate passwords match
            if (newPassword && confirmPassword && newPassword !== confirmPassword) {
              const errorEl = document.getElementById('confirmPasswordError');
              errorEl.textContent = 'New passwords do not match';
              errorEl.classList.add('show');
              isValid = false;
            }

            if (isValid) {
              // Log to console (for now, no backend)
              console.log('Password Change Request:', {
                oldPassword: oldPassword,
                newPassword: newPassword,
                timestamp: new Date().toISOString()
              });

              // Close modal and show success
              closeModal('changePasswordModal');
              changePasswordForm.reset();
              showToast('Password changed successfully', 'success');
            }
          });
        }

        // 2. Two-Factor Authentication Toggle
        const twoFactorToggle = document.getElementById('twoFactorToggle');
        const TWO_FA_STORAGE_KEY = 'twoFactorEnabled';

        // Load saved 2FA state
        function loadTwoFactorState() {
          const saved = localStorage.getItem(TWO_FA_STORAGE_KEY);
          if (saved === 'true') {
            twoFactorToggle.checked = true;
          }
        }

        // Initialize on page load
        if (twoFactorToggle) {
          loadTwoFactorState();

          twoFactorToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            
            // Save to localStorage
            localStorage.setItem(TWO_FA_STORAGE_KEY, isEnabled.toString());
            
            // Show toast notification
            if (isEnabled) {
              showToast('2FA enabled', 'success');
            } else {
              showToast('2FA disabled', 'success');
            }

            // Log to console
            console.log('Two-Factor Authentication:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 3. Delete Account
        const deleteAccountBtn = document.querySelector('.delete-button[aria-controls="deleteAccountModal"]');
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const deleteAccountCancel = document.getElementById('deleteAccountCancel');
        const deleteAccountConfirm = document.getElementById('deleteAccountConfirm');

        if (deleteAccountBtn) {
          deleteAccountBtn.addEventListener('click', () => {
            openModal('deleteAccountModal');
          });
        }

        if (deleteAccountCancel) {
          deleteAccountCancel.addEventListener('click', () => {
            closeModal('deleteAccountModal');
          });
        }

        // Close modal on overlay click
        if (deleteAccountModal) {
          deleteAccountModal.addEventListener('click', (e) => {
            if (e.target === deleteAccountModal) {
              closeModal('deleteAccountModal');
            }
          });
        }

        if (deleteAccountConfirm) {
          deleteAccountConfirm.addEventListener('click', () => {
            // Clear all localStorage
            localStorage.clear();
            
            // Log to console
            console.log('Account Deleted:', {
              timestamp: new Date().toISOString(),
              localStorageCleared: true
            });

            // Close modal
            closeModal('deleteAccountModal');

            // Show final message
            showToast('Account deleted', 'success');

            // Optional: Redirect after a delay
            setTimeout(() => {
              // Uncomment when ready to redirect
              // window.location.href = './index.html';
              console.log('Account deletion complete. Redirect would happen here.');
            }, 2000);
          });
        }
      })();

      // Preferences Functionality
      (function() {
        // Reuse toast function from Account & Security
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // Load preferences from localStorage
        function loadPreferences() {
          const saved = localStorage.getItem('userPreferences');
          if (saved) {
            try {
              return JSON.parse(saved);
            } catch (e) {
              console.error('Error parsing preferences:', e);
            }
          }
          return {
            autoSave: false,
            fontSize: 'normal',
            animations: false
          };
        }

        // Save preferences to localStorage
        function savePreferences(prefs) {
          localStorage.setItem('userPreferences', JSON.stringify(prefs));
        }

        const preferences = loadPreferences();

        // 1. Auto-Save Presentations Toggle
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        if (autoSaveToggle) {
          // Load saved state
          autoSaveToggle.checked = preferences.autoSave;

          autoSaveToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            preferences.autoSave = isEnabled;
            savePreferences(preferences);

            if (isEnabled) {
              showToast('Auto-Save enabled', 'success');
            } else {
              showToast('Auto-Save disabled', 'success');
            }

            console.log('Auto-Save:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 2. Font Size Selector
        const fontSizeButtons = document.querySelectorAll('.font-size-button[data-font-size]');
        
        function applyFontSize(size) {
          // Remove existing font size classes
          document.body.classList.remove('normal-font', 'large-font');
          
          // Add new font size class
          if (size === 'normal' || size === 'large') {
            document.body.classList.add(`${size}-font`);
          }

          // Update button states
          fontSizeButtons.forEach(btn => {
            const btnSize = btn.getAttribute('data-font-size');
            if (btnSize === size) {
              btn.classList.add('is-active');
              btn.setAttribute('aria-pressed', 'true');
            } else {
              btn.classList.remove('is-active');
              btn.setAttribute('aria-pressed', 'false');
            }
          });

          // Save to localStorage
          preferences.fontSize = size;
          savePreferences(preferences);
        }

        // Initialize font size on load
        applyFontSize(preferences.fontSize || 'normal');

        // Add click handlers to font size buttons
        fontSizeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const size = btn.getAttribute('data-font-size');
            applyFontSize(size);
          });
        });

        // 3. Enable Animations Toggle
        const animationsToggle = document.getElementById('animationsToggle');
        if (animationsToggle) {
          // Load saved state
          animationsToggle.checked = preferences.animations;
          
          // Apply initial state
          if (preferences.animations) {
            document.body.classList.add('animations-on');
          } else {
            document.body.classList.remove('animations-on');
          }

          animationsToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            preferences.animations = isEnabled;
            savePreferences(preferences);

            if (isEnabled) {
              document.body.classList.add('animations-on');
              showToast('Animations enabled', 'success');
            } else {
              document.body.classList.remove('animations-on');
              showToast('Animations disabled', 'success');
            }

            console.log('Animations:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 4. AI Assistant API Key Management
        const apiKeyInput = document.getElementById('geminiApiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        // Load saved API key on page load
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
          apiKeyInput.value = savedApiKey;
          apiKeyStatus.textContent = '✓ API key saved';
          apiKeyStatus.style.color = '#00c853';
        }

        // Save API key
        saveApiKeyBtn.addEventListener('click', () => {
          const apiKey = apiKeyInput.value.trim();
          if (apiKey) {
            localStorage.setItem('gemini_api_key', apiKey);
            apiKeyStatus.textContent = '✓ API key saved successfully';
            apiKeyStatus.style.color = '#00c853';
            showToast('API key saved', 'success');
          } else {
            apiKeyStatus.textContent = 'Please enter an API key';
            apiKeyStatus.style.color = '#ff6b6b';
          }
        });

        // Clear API key
        clearApiKeyBtn.addEventListener('click', () => {
          apiKeyInput.value = '';
          localStorage.removeItem('gemini_api_key');
          apiKeyStatus.textContent = 'API key cleared';
          apiKeyStatus.style.color = 'rgba(255, 255, 255, 0.6)';
          showToast('API key cleared', 'success');
        });

        // Update status on input
        apiKeyInput.addEventListener('input', () => {
          if (apiKeyInput.value.trim()) {
            apiKeyStatus.textContent = 'Click Save to store the API key';
            apiKeyStatus.style.color = 'rgba(255, 255, 255, 0.6)';
          }
        });
      })();

      // Notifications Functionality
      (function() {
        // Reuse toast function
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // Load notification state from localStorage
        function loadNotificationState(key) {
          const saved = localStorage.getItem(key);
          return saved === 'true';
        }

        // Save notification state to localStorage
        function saveNotificationState(key, value) {
          localStorage.setItem(key, value.toString());
        }

        // Setup notification toggle
        function setupNotificationToggle(toggleId, storageKey, messages) {
          const toggle = document.getElementById(toggleId);
          if (!toggle) return;

          // Load saved state (default to false if not set)
          const savedState = loadNotificationState(storageKey);
          toggle.checked = savedState;

          // Add change event listener
          toggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            saveNotificationState(storageKey, isEnabled);

            // Show appropriate toast message
            if (isEnabled) {
              showToast(messages.on, 'success');
            } else {
              showToast(messages.off, 'success');
            }

            // Log to console
            console.log(`${toggleId}:`, {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 1. Project Activity
        setupNotificationToggle('notifProjectActivity', 'notif_project_activity', {
          on: 'Project activity notifications enabled',
          off: 'Project activity notifications disabled'
        });

        // 2. Comments & Mentions
        setupNotificationToggle('notifCommentsMentions', 'notif_comments_mentions', {
          on: 'You\'ll be notified when someone mentions you',
          off: 'Comments & mentions notifications disabled'
        });

        // 3. Group Invites
        setupNotificationToggle('notifGroupInvites', 'notif_group_invites', {
          on: 'Group invite notifications enabled',
          off: 'Group invite notifications disabled'
        });

        // 4. Email Updates
        setupNotificationToggle('notifEmailUpdates', 'notif_email_updates', {
          on: 'Email updates enabled',
          off: 'Email updates disabled'
        });
      })();

      // Collaboration Functionality
      (function() {
        // Reuse toast function
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // 1. Default Sharing Dropdown
        const defaultSharingSelect = document.getElementById('defaultSharingSelect');
        const defaultSharingDisplay = document.getElementById('defaultSharingDisplay');
        const COLLAB_SHARING_KEY = 'collab_default_sharing';
        const DEFAULT_SHARING = 'Private';

        // Load saved sharing preference
        function loadDefaultSharing() {
          const saved = localStorage.getItem(COLLAB_SHARING_KEY);
          return saved || DEFAULT_SHARING;
        }

        // Save sharing preference
        function saveDefaultSharing(value) {
          localStorage.setItem(COLLAB_SHARING_KEY, value);
        }

        // Initialize default sharing on load
        if (defaultSharingSelect && defaultSharingDisplay) {
          const savedSharing = loadDefaultSharing();
          defaultSharingSelect.value = savedSharing;
          defaultSharingDisplay.textContent = savedSharing;

          // Update display when select changes
          defaultSharingSelect.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            defaultSharingDisplay.textContent = selectedValue;
            saveDefaultSharing(selectedValue);

            // Show toast notification
            showToast(`Default sharing set to: ${selectedValue}`, 'success');

            // Log to console
            console.log('Default Sharing:', {
              value: selectedValue,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 2. Show Active Collaborators Toggle
        const collabShowActive = document.getElementById('collabShowActive');
        const COLLAB_SHOW_ACTIVE_KEY = 'collab_show_active';

        // Load saved state
        function loadShowActiveState() {
          const saved = localStorage.getItem(COLLAB_SHOW_ACTIVE_KEY);
          return saved === 'true';
        }

        // Save state
        function saveShowActiveState(value) {
          localStorage.setItem(COLLAB_SHOW_ACTIVE_KEY, value.toString());
        }

        // Initialize toggle on load
        if (collabShowActive) {
          const savedState = loadShowActiveState();
          collabShowActive.checked = savedState;

          // Add change event listener
          collabShowActive.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            saveShowActiveState(isEnabled);

            // Show toast notification
            if (isEnabled) {
              showToast('Active collaborator indicators enabled', 'success');
            } else {
              showToast('Active collaborator indicators hidden', 'success');
            }

            // Log to console
            console.log('Show Active Collaborators:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }
      })();

      // Connected Accounts Functionality
      (function() {
        // Reuse toast function
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // Load connection state from localStorage
        function loadConnectionState(key) {
          const saved = localStorage.getItem(key);
          return saved === 'true';
        }

        // Save connection state to localStorage
        function saveConnectionState(key, value) {
          localStorage.setItem(key, value.toString());
        }

        // Update button state
        function updateButtonState(button, isConnected) {
          if (isConnected) {
            button.textContent = 'Connected ✓';
            button.classList.add('connected');
          } else {
            button.textContent = 'Connect';
            button.classList.remove('connected');
          }
        }

        // Setup connection button
        function setupConnectionButton(buttonId, storageKey, toastMessage) {
          const button = document.getElementById(buttonId);
          if (!button) return;

          // Load saved state and update button
          const initialState = loadConnectionState(storageKey);
          updateButtonState(button, initialState);

          // Add click event listener
          button.addEventListener('click', () => {
            // Get current state
            const currentState = loadConnectionState(storageKey);
            // Toggle state
            const newState = !currentState;
            saveConnectionState(storageKey, newState);
            updateButtonState(button, newState);

            // Show toast only when connecting (not disconnecting)
            if (newState) {
              showToast(toastMessage, 'success');
            }

            // Log to console
            console.log(`${buttonId}:`, {
              connected: newState,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 1. Google Drive
        setupConnectionButton('connectGoogleDrive', 'connected_google_drive', 'Google Drive successfully connected.');

        // 2. GitHub
        setupConnectionButton('connectGitHub', 'connected_github', 'GitHub account connected.');

        // 3. Dropbox
        setupConnectionButton('connectDropbox', 'connected_dropbox', 'Dropbox connected.');
      })();

      // App Customization Functionality
      (function() {
        // Reuse toast function
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => {
                toast.className = 'toast';
              }, 300);
            }, 3000);
          }
        }

        // 1. Rounded Corners Toggle
        const roundedCornersToggle = document.getElementById('roundedCornersToggle');
        const ROUNDED_CORNERS_KEY = 'ui_rounded_corners';

        function loadRoundedCornersState() {
          const saved = localStorage.getItem(ROUNDED_CORNERS_KEY);
          return saved === 'true';
        }

        function saveRoundedCornersState(value) {
          localStorage.setItem(ROUNDED_CORNERS_KEY, value.toString());
        }

        function applyRoundedCorners(isEnabled) {
          if (isEnabled) {
            document.body.classList.add('rounded-ui');
          } else {
            document.body.classList.remove('rounded-ui');
          }
        }

        if (roundedCornersToggle) {
          const initialState = loadRoundedCornersState();
          roundedCornersToggle.checked = initialState;
          applyRoundedCorners(initialState);

          roundedCornersToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            saveRoundedCornersState(isEnabled);
            applyRoundedCorners(isEnabled);

            if (isEnabled) {
              showToast('Rounded corners enabled.', 'success');
            } else {
              showToast('Rounded corners disabled.', 'success');
            }

            console.log('Rounded Corners:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 2. Glass Effect Toggle
        const glassEffectToggle = document.getElementById('glassEffectToggle');
        const GLASS_EFFECT_KEY = 'ui_glass_effect';

        function loadGlassEffectState() {
          const saved = localStorage.getItem(GLASS_EFFECT_KEY);
          return saved === 'true';
        }

        function saveGlassEffectState(value) {
          localStorage.setItem(GLASS_EFFECT_KEY, value.toString());
        }

        function applyGlassEffect(isEnabled) {
          if (isEnabled) {
            document.body.classList.add('glass-ui');
          } else {
            document.body.classList.remove('glass-ui');
          }
        }

        if (glassEffectToggle) {
          const initialState = loadGlassEffectState();
          glassEffectToggle.checked = initialState;
          applyGlassEffect(initialState);

          glassEffectToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            saveGlassEffectState(isEnabled);
            applyGlassEffect(isEnabled);

            if (isEnabled) {
              showToast('Glass effect enabled.', 'success');
            } else {
              showToast('Glass effect disabled.', 'success');
            }

            console.log('Glass Effect:', {
              enabled: isEnabled,
              timestamp: new Date().toISOString()
            });
          });
        }

        // 3. UI Density Dropdown
        const uiDensitySelect = document.getElementById('uiDensitySelect');
        const uiDensityDisplay = document.getElementById('uiDensityDisplay');
        const UI_DENSITY_KEY = 'ui_density';
        const DEFAULT_DENSITY = 'comfortable';

        function loadUIDensity() {
          const saved = localStorage.getItem(UI_DENSITY_KEY);
          return saved || DEFAULT_DENSITY;
        }

        function saveUIDensity(value) {
          localStorage.setItem(UI_DENSITY_KEY, value);
        }

        function applyUIDensity(density) {
          // Remove all density classes
          document.body.classList.remove('ui-density-compact', 'ui-density-comfortable', 'ui-density-spacious');
          
          // Add selected density class
          if (density === 'compact' || density === 'comfortable' || density === 'spacious') {
            document.body.classList.add(`ui-density-${density}`);
          }

          // Update display text (capitalize first letter)
          const displayText = density.charAt(0).toUpperCase() + density.slice(1);
          if (uiDensityDisplay) {
            uiDensityDisplay.textContent = displayText;
          }
        }

        if (uiDensitySelect && uiDensityDisplay) {
          const savedDensity = loadUIDensity();
          uiDensitySelect.value = savedDensity;
          applyUIDensity(savedDensity);

          uiDensitySelect.addEventListener('change', (e) => {
            const selectedDensity = e.target.value;
            saveUIDensity(selectedDensity);
            applyUIDensity(selectedDensity);

            const displayText = selectedDensity.charAt(0).toUpperCase() + selectedDensity.slice(1);
            showToast(`UI layout set to ${displayText}.`, 'success');

            console.log('UI Density:', {
              density: selectedDensity,
              timestamp: new Date().toISOString()
            });
          });
        }
      })();
      
      // Load saved background color from localStorage
      const savedBg = localStorage.getItem('siteBackgroundColor') || '#0b3d2e';
      if (savedBg === '#000000') {
        document.body.classList.add('dark-theme');
        document.body.style.background = '';
        document.body.style.color = '';
        document.querySelector('header').classList.add('dark-theme');
        document.querySelector('header').style.background = '';
      } else if (savedBg === '#ffffff') {
        document.body.classList.add('light-mode');
        document.body.style.background = '';
        document.body.style.color = '';
        document.querySelector('header').classList.add('light-mode');
        document.querySelector('header').style.background = '';
      } else {
        document.body.style.background = savedBg;
        document.querySelector('header').style.background = savedBg;
      }
      
      // Set selected option based on saved value
      const options = document.querySelectorAll('.color-option');
      options.forEach(option => {
        option.removeAttribute('data-selected');
        option.classList.remove('focused');
        const checkIcon = option.querySelector('.check-icon');
        if (option.getAttribute('data-color') === savedBg) {
          option.setAttribute('data-selected', 'true');
          checkIcon.textContent = '✓';
        } else {
          checkIcon.textContent = '';
        }
      });

      // Update background color when option is clicked
      options.forEach(option => {
        option.addEventListener('click', () => {
          const color = option.getAttribute('data-color');
          
          // Update all options
          options.forEach(opt => {
            opt.removeAttribute('data-selected');
            opt.classList.remove('focused');
            const icon = opt.querySelector('.check-icon');
            if (opt === option) {
              opt.setAttribute('data-selected', 'true');
              icon.textContent = '✓';
            } else {
              icon.textContent = '';
            }
          });
          
          // Update body background
          document.body.classList.remove('dark-theme', 'light-mode');
          document.querySelector('header').classList.remove('dark-theme', 'light-mode');
          
          if (color === '#000000') {
            document.body.classList.add('dark-theme');
            document.body.style.background = '';
            document.body.style.color = '';
            document.querySelector('header').classList.add('dark-theme');
            document.querySelector('header').style.background = '';
          } else if (color === '#ffffff') {
            document.body.classList.add('light-mode');
            document.body.style.background = '';
            document.body.style.color = '';
            document.querySelector('header').classList.add('light-mode');
            document.querySelector('header').style.background = '';
          } else {
            document.body.style.background = color;
            document.querySelector('header').style.background = color;
            document.querySelector('.logo').style.color = 'white';
            document.querySelectorAll('.menu a').forEach(a => a.style.color = 'white');
          }
          
          // Save to localStorage
          localStorage.setItem('siteBackgroundColor', color);
          
          // Also update Home.html if it's open
          if (window.opener) {
            window.opener.postMessage({ type: 'updateBackground', color: color }, '*');
          }
        });

        // Add focus effect on hover
        option.addEventListener('mouseenter', () => {
          if (!option.hasAttribute('data-selected')) {
            option.classList.add('focused');
          }
        });

        option.addEventListener('mouseleave', () => {
          option.classList.remove('focused');
        });

        // Keyboard navigation
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            option.click();
          }
        });

        option.setAttribute('tabindex', '0');
      });

      // Listen for messages from other windows
      window.addEventListener('message', (e) => {
        if (e.data.type === 'updateBackground') {
          const color = e.data.color;
          
          document.body.classList.remove('dark-theme', 'light-mode');
          document.querySelector('header').classList.remove('dark-theme', 'light-mode');
          
          if (color === '#000000') {
            document.body.classList.add('dark-theme');
            document.body.style.background = '';
            document.body.style.color = '';
            document.querySelector('header').classList.add('dark-theme');
            document.querySelector('header').style.background = '';
          } else if (color === '#ffffff') {
            document.body.classList.add('light-mode');
            document.body.style.background = '';
            document.body.style.color = '';
            document.querySelector('header').classList.add('light-mode');
            document.querySelector('header').style.background = '';
          } else {
            document.body.style.background = color;
            document.querySelector('header').style.background = color;
          }
          
          // Update selected option
          options.forEach(option => {
            option.removeAttribute('data-selected');
            option.classList.remove('focused');
            const checkIcon = option.querySelector('.check-icon');
            if (option.getAttribute('data-color') === color) {
              option.setAttribute('data-selected', 'true');
              checkIcon.textContent = '✓';
            } else {
              checkIcon.textContent = '';
            }
          });
        }
        if (e.data.type === 'updateLanguage') {
          const lang = e.data.language;
          localStorage.setItem('siteLanguage', lang);
          applyTranslations(lang);
        }
      });

      // About card dynamic fields
      const ABOUT_APP_VERSION = '1.0.0';
      const ABOUT_DEV_NAMES = ['Mohammed Al-Otaibi', 'Ahmed Al-Asmari', 'Ali Al-Khathami'];
      const ABOUT_CONTACT_EMAIL = 'Mohammedfake56@gmail.com';

      const versionEl = document.getElementById('appVersion');
      const devNameEl = document.getElementById('devName');
      const contactEl = document.getElementById('contactEmail');
      const privacyLinkEl = document.getElementById('privacyPolicyLink');

      if (versionEl) versionEl.textContent = ABOUT_APP_VERSION;
      if (devNameEl) devNameEl.innerHTML = ABOUT_DEV_NAMES.join('<br>');
      if (contactEl) {
        contactEl.textContent = ABOUT_CONTACT_EMAIL;
        contactEl.href = 'mailto:' + ABOUT_CONTACT_EMAIL;
      }

      if (privacyLinkEl) {
        privacyLinkEl.addEventListener('click', (event) => {
          event.preventDefault();
          const lang = localStorage.getItem('siteLanguage') || document.documentElement.lang || 'en';
          const dict = (window.translations && window.translations[lang]) || window.translations.en;
          const message = (dict && dict['common.privacyComingSoon']) || 'Privacy policy coming soon.';
          alert(message);
        });
      }

      if (typeof window.applyTranslations === 'function') {
        window.applyTranslations(localStorage.getItem('siteLanguage') || document.documentElement.lang || 'en');
      }

      // Make translations available globally
      window.translations = translations;
      
      // Load saved language
      const savedLang = localStorage.getItem('siteLanguage') || 'en';
      applyTranslations(savedLang);

      // Language selector functionality
      const langOptions = document.querySelectorAll('#languageSelector .color-option');
      langOptions.forEach(option => {
        option.removeAttribute('data-selected');
        option.classList.remove('focused');
        const checkIcon = option.querySelector('.check-icon');
        if (option.getAttribute('data-lang') === savedLang) {
          option.setAttribute('data-selected', 'true');
          checkIcon.textContent = '✓';
        } else {
          checkIcon.textContent = '';
        }
      });

      langOptions.forEach(option => {
        option.addEventListener('click', () => {
          const lang = option.getAttribute('data-lang');
          
          // Update all options
          langOptions.forEach(opt => {
            opt.removeAttribute('data-selected');
            opt.classList.remove('focused');
            const icon = opt.querySelector('.check-icon');
            if (opt === option) {
              opt.setAttribute('data-selected', 'true');
              icon.textContent = '✓';
            } else {
              icon.textContent = '';
            }
          });
          
          // Save to localStorage
          localStorage.setItem('siteLanguage', lang);
          
          // Apply translations
          applyTranslations(lang);
          
          // Notify other windows
          if (window.opener) {
            window.opener.postMessage({ type: 'updateLanguage', language: lang }, '*');
          }
          
          // Broadcast to all windows
          window.postMessage({ type: 'updateLanguage', language: lang }, '*');
        });

        // Add focus effect on hover
        option.addEventListener('mouseenter', () => {
          if (!option.hasAttribute('data-selected')) {
            option.classList.add('focused');
          }
        });

        option.addEventListener('mouseleave', () => {
          option.classList.remove('focused');
        });

        // Keyboard navigation
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            option.click();
          }
        });

        option.setAttribute('tabindex', '0');
      });
    </script>

    <!-- About App Modal -->
    <div class="modal-overlay about-modal-overlay" id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutModalHeading" aria-hidden="true">
      <div class="modal-card about-modal-card">
        <button class="about-modal-close" onclick="closeAboutModal()" aria-label="Close About modal">
          <i class="fas fa-times"></i>
        </button>
        <div class="about-modal-content">
          <h3 id="aboutModalHeading" class="about-modal-title">About Aramco Digital SlideMaker</h3>
          <p class="about-modal-description">
            Aramco Digital SlideMaker is a modern presentation builder designed to help teams create professional slides quickly. It supports real-time collaboration, smart templates, AI assistance, and a clean, modern interface.
          </p>
          <ul class="about-modal-features">
            <li><i class="fas fa-check-circle"></i> Smart ready-made templates</li>
            <li><i class="fas fa-check-circle"></i> Real-time team collaboration</li>
            <li><i class="fas fa-check-circle"></i> AI-powered slide suggestions</li>
            <li><i class="fas fa-check-circle"></i> Organized group workspaces</li>
            <li><i class="fas fa-check-circle"></i> Smooth exporting and sharing tools</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- AI Assistant Floating Button -->
    <button class="ai-assistant-btn" id="aiAssistantBtn" onclick="toggleChatbot()" aria-label="Open AI Assistant">
      <i class="fas fa-robot"></i>
      <span>AI Assistant</span>
    </button>

    <!-- AI Assistant Chatbot Window -->
    <div class="ai-chatbot" id="ai-chatbot">
      <div class="chatbot-header">
        <div class="chatbot-title">
          <i class="fas fa-robot"></i>
          <span>AI Assistant</span>
        </div>
        <button class="chatbot-close" onclick="toggleChatbot()" aria-label="Close chatbot">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="chatbot-messages" id="chatbot-messages">
        <!-- Messages will be added here -->
      </div>
      <div class="chatbot-input-container">
        <input 
          type="text" 
          id="chatbot-input" 
          class="chatbot-input" 
          placeholder="Ask me about SlideMaker..."
          autocomplete="off"
        >
        <button class="chatbot-voice-btn" id="voice-input-btn" aria-label="Voice input">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="chatbot-send-btn" id="send-input-btn" aria-label="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
    
    <!-- Performance Optimization -->
    <script src="./scripts/performance.js"></script>
    
    <!-- AI Assistant Chatbot Module -->
    <script src="./scripts/chatbot.js"></script>
  </body>
  </html>

