<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Slides Web</title>
  <meta name="color-scheme" content="light dark">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lGdQDzFv1NNpJBWlAbIYW/W2PASi6DPd7OJbRRqtD9h5pz50jdK5Zk90un0nLBKBPXn1HULICwhf66A86A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/PHX0JrB9c4ZzG3eHn2mSYYWWVseGbIJcYsCkP3BL+J36xTV3Bd6p+nNL39CNgW0n9K8ZlR5BHY6royEUnXX7Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-4R7n2sFTNK1VNHYsYAGdivgLPgAvFp8ZUBKbjsggq09uXBJgp7wa9u0edPFpKnz03Wx/ju0RduCMsZ/H6GfPmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.min.js" integrity="sha512-F8+aoCA8DmF5asJQHKqGmMwakyfeG5edDx9yv7zhtfQczr6gs3qK1D7w+l0kcRAg1WoljzWEGngZFV3nC8slVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { font-family: 'Poppins', sans-serif; color: var(--text-primary); background: transparent; }
    .app { display: grid; grid-template-rows: 64px 1fr; height: 100vh; }
    .topbar { display: grid; grid-template-columns: 240px 1fr auto; align-items: center; gap: 12px; padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08); background: rgba(0, 40, 25, 0.85); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 5; border-radius: 0 0 18px 18px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
    .brand-badge { width: 28px; height: 28px; border-radius: 6px; background: #fbbc04; position: relative; box-shadow: inset 0 0 0 2px rgba(0,0,0,.04); }
    .brand-badge::after { content:""; position:absolute; inset:6px; background:#fff; border-radius:2px; }
    .doc { display:flex; align-items:center; gap:10px; }
    .doc input { border:none; outline:none; font-weight:700; font-size:14px; background:rgba(255,255,255,0.08); color:var(--text-primary); padding:6px 8px; border-radius:6px; transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease; }
    .doc input:hover { background:rgba(255,255,255,0.15); transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
    .actions { display: flex; align-items: center; gap: 10px; }
    button:not(.toolbar-pill) { background: linear-gradient(90deg, #00796b, #00c853); color: #fff; border: 1px solid transparent; padding: 8px 14px; border-radius: 16px; cursor: pointer; font-weight: 600; transition: transform 0.25s ease, box-shadow 0.35s ease, background 0.35s ease; }
    button:not(.toolbar-pill):hover { background: linear-gradient(90deg, var(--brand-green), var(--brand-green-bright)); transform: scale(1.02); box-shadow: 0 10px 24px rgba(0, 200, 120, 0.35); }
    button.btn-secondary { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.24); color: var(--text-primary); }
    button.btn-secondary:hover { background: rgba(0, 168, 107, 0.32); border-color: rgba(0, 222, 168, 0.45); }
    button.btn-danger { background: #ef4444; }
    .layout { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 64px); }
    .sidebar { border-right: 1px solid rgba(255,255,255,0.08); padding: 12px; overflow: auto; background: rgba(0, 40, 25, 0.55); backdrop-filter: blur(10px); }
    .slides-list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .slide-item { display: grid; grid-template-columns: 96px 1fr auto; align-items: center; gap: 8px; padding: 8px; border: 1px solid rgba(0,255,150,0.12);
      border-radius: 12px; background: rgba(0, 55, 40, 0.65); cursor: pointer; box-shadow: 0 12px 24px rgba(0,0,0,0.2); transition: transform 0.25s ease, box-shadow 0.35s ease, border-color 0.35s ease; }
    .slide-item:hover { transform: scale(1.015); box-shadow: 0 16px 32px rgba(0,0,0,0.28); border-color: rgba(0,255,150,0.3); }
    .slide-item.active { outline: 2px solid var(--brand-green); }
    .thumb { width: 96px; height: 60px; border-radius: 8px; background: rgba(255,255,255,0.92); border: none; position: relative; overflow: hidden; }
    .thumb .mini { transform: scale(.18); transform-origin: top left; width: 530px; height: 300px; }
    .slide-title { color: var(--text-primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .slide-meta { color: var(--text-muted); font-size: 12px; }
    .editor-wrap { padding: 16px; display: grid; grid-template-rows: auto 1fr; gap: 12px; background: rgba(0, 40, 25, 0.4); backdrop-filter: blur(12px); border-radius: 18px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); margin: 16px; border: 1px solid rgba(0, 255, 150, 0.12); opacity: 0; transform: translateY(24px); animation: wrapperFade 0.8s ease forwards; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; background: rgba(5, 60, 35, 0.95); padding:10px; border:1px solid rgba(0,255,150,0.12); border-radius:12px; box-shadow: 0 8px 25px rgba(0,0,0,0.25); }
    .toolbar button { border: 1px solid transparent; background: rgba(255,255,255,0.12); color: inherit; }
    .toolbar button:hover,
    .toolbar button:focus-visible { background: rgba(0, 168, 107, 0.32); transform: translateY(-2px) scale(1.03); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
    .toolbar button[data-cmd="bold"] { font-weight: 800; }
    .toolbar button[data-cmd="italic"] { font-style: italic; }
    .toolbar button[data-cmd="formatBlock"][data-value="h2"] { font-weight: 700; font-size: 15px; }
    .canvas { display: grid; place-items: center; overflow: auto; background: rgba(255,255,255,0.08); border-radius: 22px; padding: 24px; box-shadow: 0 18px 38px rgba(0,0,0,0.28); border: 1px solid rgba(255,255,255,0.18); opacity: 0; transform: translateY(24px); animation: canvasReveal 0.9s ease forwards; animation-delay: 0.15s; }
    .slide-canvas { width: min(960px, 90vw); aspect-ratio: 16 / 9; background: #fff; color: #111827; border-radius: 18px; border: 1px solid rgba(0,0,0,0.08);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06); display: grid; grid-template-rows: auto 1fr; padding: 32px; overflow: hidden; }
    .slide-canvas input.title { border: none; border-bottom: 1px dashed rgba(0,0,0,0.12); outline: none; font-size: clamp(20px, 4vw, 40px);
      font-weight: 800; margin-bottom: 16px; width: 100%; }
    .slide-canvas .content { outline: none; font-size: clamp(14px, 2.2vw, 22px); line-height: 1.5; overflow: auto; }
    .slide-canvas .content:focus-visible { box-shadow: 0 0 0 3px rgba(0,200,120,0.18); border-radius: 12px; }
    .footer-hint { color: var(--text-muted); font-size: 12px; text-align: center; padding: 4px 0; }
    .btn-mini { padding: 4px 8px; border-radius: 6px; }
    .btn-mini:hover { transform: translateY(-1px); }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } .sidebar { order: 2; height: 220px; } .editor-wrap { order: 1; } }
    @keyframes wrapperFade { 0% { opacity: 0; transform: translateY(24px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes canvasReveal { 0% { opacity: 0; transform: translateY(24px); } 100% { opacity: 1; transform: translateY(0); } }
    .save-notification {
      position: fixed;
      top: 90px;
      right: 24px;
      background: rgba(0, 168, 107, 0.95);
      color: #f4fff9;
      padding: 14px 20px;
      border-radius: 14px;
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.35);
      opacity: 0;
      transform: translateY(-12px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 5200;
      pointer-events: none;
      font-weight: 600;
    }
    .save-notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .export-modal {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 20, 15, 0.68);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      z-index: 5100;
    }
    .export-modal.show {
      display: flex;
    }
    .export-dialog {
      background: rgba(3, 32, 23, 0.95);
      border: 1px solid rgba(0, 222, 168, 0.2);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
      width: min(440px, 92vw);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      color: #e8f5e9;
    }
    .export-body { display: flex; flex-direction: column; gap: 16px; }
    .export-field { display: flex; flex-direction: column; gap: 6px; }
    .export-field label { font-size: 0.9rem; font-weight: 600; color: rgba(200, 240, 225, 0.86); }
    .export-field input {
      background: rgba(3, 45, 30, 0.82);
      border: 1px solid rgba(0, 222, 168, 0.25);
      border-radius: 12px;
      padding: 12px;
      color: #e8f5e9;
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    .export-field input:focus {
      outline: none;
      border-color: rgba(0, 222, 168, 0.55);
      box-shadow: 0 0 0 2px rgba(0, 222, 168, 0.25);
    }
    .export-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .export-header h2 { margin: 0; font-size: 1.25rem; }
    .export-close {
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: inherit;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
    }
    .export-close:hover { background: rgba(0, 200, 120, 0.35); transform: scale(1.05); }
    .export-options { display: grid; gap: 12px; }
    .export-option {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      border: 1px solid rgba(0, 255, 170, 0.2);
      background: rgba(4, 60, 40, 0.55);
      border-radius: 14px;
      padding: 14px 16px;
      cursor: pointer;
      text-align: left;
      transition: transform 0.2s ease, box-shadow 0.3s ease, border 0.3s ease, background 0.3s ease;
      color: inherit;
      font: inherit;
    }
    .export-option-input {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(0, 222, 168, 0.55);
      margin-top: 4px;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }
    .export-option-input::after {
      content: '';
      position: absolute;
      inset: 3px;
      border-radius: 50%;
      background: rgba(0, 222, 168, 0.85);
      transform: scale(0);
      transition: transform 0.2s ease;
    }
    .export-option-input:checked::after {
      transform: scale(1);
    }
    .export-option:hover,
    .export-option:focus-within {
      transform: translateY(-2px);
      border-color: rgba(0, 222, 168, 0.55);
      background: rgba(5, 85, 54, 0.8);
      box-shadow: 0 14px 38px rgba(0, 222, 168, 0.25);
    }
    .export-option.active {
      border-color: rgba(0, 222, 168, 0.65);
      background: rgba(5, 90, 56, 0.92);
      box-shadow: 0 16px 38px rgba(0, 222, 168, 0.35);
    }
    .export-option-details { display: flex; flex-direction: column; gap: 4px; }
    .export-option-kicker {
      font-weight: 600;
      font-size: 0.9rem;
      color: rgba(0, 222, 168, 0.85);
      min-width: 44px;
    }
    .export-option-label { font-weight: 600; font-size: 1rem; }
    .export-option-note { color: rgba(200, 240, 225, 0.7); font-size: 0.85rem; display: block; }
    .export-footer { display: flex; justify-content: flex-end; gap: 12px; }
    .canvas.exporting {
      pointer-events: none;
    }
    .canvas.exporting input,
    .canvas.exporting .content {
      outline: none;
      border-color: transparent;
    }
  </style>
</head>
<body class="page-container">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true"></div>
        <div>Slides</div>
      </div>
      <div class="doc">
        <input id="fileName" value="Untitled presentation" aria-label="Document name">
      </div>
      <div class="actions">
        <button type="button" class="toolbar-pill" data-variant="blue" data-tooltip="Add New Slide" id="btn-new" aria-label="New Slide">
          <i class="fas fa-plus"></i>
          <span class="label">New</span>
        </button>
        <button type="button" class="toolbar-pill" data-variant="blue" data-tooltip="Duplicate Slide" id="btn-duplicate" aria-label="Duplicate Slide">
          <i class="fas fa-copy"></i>
          <span class="label">Duplicate</span>
        </button>
        <button type="button" class="toolbar-pill" data-variant="red" data-tooltip="Delete Slide" id="btn-delete" aria-label="Delete Slide">
          <i class="fas fa-trash"></i>
          <span class="label">Delete</span>
        </button>
        <button type="button" class="toolbar-pill" data-variant="neutral" data-tooltip="Reset Presentation" id="btn-clear" aria-label="Reset Presentation">
          <i class="fas fa-rotate-right"></i>
          <span class="label">Reset</span>
        </button>
        <button type="button" class="toolbar-pill" data-variant="green" data-tooltip="Export Presentation" id="btn-export" aria-label="Export Presentation">
          <i class="fas fa-file-export"></i>
          <span class="label">Export</span>
        </button>
      </div>
    </div>
    <div class="layout">
      <aside class="sidebar">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="font-weight:700;">Slides</div>
          <div class="slide-meta" id="count"></div>
        </div>
        <div id="slides" class="slides-list"></div>
        <div class="footer-hint">Tip: Use ↑/↓ to navigate, Cmd/Ctrl+Enter to add</div>
      </aside>
      <main class="editor-wrap">
        <div class="toolbar">
          <button class="btn-secondary" data-cmd="bold" title="Bold">B</button>
          <button class="btn-secondary" data-cmd="italic" title="Italic">I</button>
          <button class="btn-secondary" data-cmd="insertUnorderedList" title="Bulleted list">• List</button>
          <button class="btn-secondary" data-cmd="formatBlock" data-value="h2" title="Heading">H2</button>
          <button class="btn-secondary" data-cmd="formatBlock" data-value="p" title="Paragraph">P</button>
        </div>
        <div class="canvas">
          <div class="slide-canvas">
            <input id="title" class="title" placeholder="Slide title">
            <div id="content" class="content" contenteditable="true" spellcheck="false" placeholder="Start typing..."></div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <div class="save-notification" id="saveNotification">Presentation saved!</div>
  <div class="export-modal" id="exportModal" aria-hidden="true">
    <div class="export-dialog" role="dialog" aria-modal="true" aria-labelledby="exportDialogTitle">
      <div class="export-header">
        <h2 id="exportDialogTitle">Export Presentation</h2>
        <button type="button" class="export-close" id="exportClose" aria-label="Close export dialog">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="export-body">
        <div class="export-field">
          <label for="exportFileName">File name</label>
          <input type="text" id="exportFileName" maxlength="80" autocomplete="off" placeholder="presentation-name">
        </div>
        <div class="export-options" id="exportOptions"></div>
      </div>
      <div class="export-footer">
        <button type="button" class="toolbar-pill" data-variant="neutral" id="exportCancel">
          <span class="label">Cancel</span>
        </button>
        <button type="button" class="toolbar-pill" data-variant="green" id="exportConfirm" disabled>
          <span class="label">Save</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const storageKey = 'slides.web.v2';
    let slides = [];
    let selectedId = null;
    let fileName = 'Untitled presentation';

    const el = (id) => document.getElementById(id);
    const slidesEl = el('slides');
    const titleEl = el('title');
    const contentEl = el('content');
    const countEl = el('count');
    const fileNameEl = el('fileName');
    const saveNotification = document.getElementById('saveNotification');
    const exportModal = document.getElementById('exportModal');
    const exportOptionsContainer = document.getElementById('exportOptions');
    const exportCloseBtn = document.getElementById('exportClose');
    const exportCancelBtn = document.getElementById('exportCancel');
    const exportFileNameInput = document.getElementById('exportFileName');
    const exportConfirmBtn = document.getElementById('exportConfirm');
    let toastTimeout;
    let selectedExportFormat = null;
    let exportModalPreviousFocus = null;
    const EXPORT_FORMATS = [
      { id: 'pdf', label: 'PDF Document', note: 'Printable version of your slides.' },
      { id: 'pptx', label: 'PowerPoint (PPTX)', note: 'Open and edit in Microsoft PowerPoint.' },
      { id: 'png', label: 'PNG Images (ZIP)', note: 'Export each slide as a transparent image.' },
      { id: 'jpg', label: 'JPG Images (ZIP)', note: 'Export each slide as a photo-friendly image.' },
      { id: 'html', label: 'Interactive HTML', note: 'Share as a standalone web page.' },
      { id: 'json', label: 'Editor JSON', note: 'Backup for reloading into SlideMaker.' }
    ];
    const EXPORT_LABEL_MAP = EXPORT_FORMATS.reduce((map, fmt) => {
      map[fmt.id] = fmt.label;
      return map;
    }, {});

    function showToast(message, duration = 2400) {
      clearTimeout(toastTimeout);
      saveNotification.textContent = message;
      saveNotification.classList.add('show');
      if (duration !== null) {
        toastTimeout = setTimeout(() => {
          saveNotification.classList.remove('show');
        }, duration);
      }
    }

    function hideToast() {
      clearTimeout(toastTimeout);
      saveNotification.classList.remove('show');
    }

    function sanitizeFileName(value) {
      return (value || 'presentation')
        .replace(/[^a-z0-9\-_]+/gi, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^-|-$/g, '')
        .toLowerCase() || 'presentation';
    }

    function getExportBaseName() {
      const activeSlide = currentSlide();
      const fallbackTitle = activeSlide && activeSlide.title ? activeSlide.title : 'slides';
      return sanitizeFileName(fileName || fallbackTitle);
    }

    function downloadBlob(blob, fileName) {
      console.log('Triggering download…', fileName);
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      anchor.href = url;
      anchor.download = fileName;
      document.body.appendChild(anchor);
      anchor.click();
      anchor.remove();
      URL.revokeObjectURL(url);
      console.log('Download successful.', fileName);
    }

    function renderExportOptions() {
      exportOptionsContainer.innerHTML = '';
      selectedExportFormat = null;
      exportConfirmBtn.disabled = true;
      EXPORT_FORMATS.forEach(format => {
        const option = document.createElement('label');
        option.className = 'export-option';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'exportFormat';
        input.value = format.id;
        input.className = 'export-option-input';

        const kicker = document.createElement('span');
        kicker.className = 'export-option-kicker';
        kicker.textContent = format.id.toUpperCase();

        const details = document.createElement('div');
        details.className = 'export-option-details';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'export-option-label';
        labelSpan.textContent = format.label;
        const noteSpan = document.createElement('span');
        noteSpan.className = 'export-option-note';
        noteSpan.textContent = format.note;
        details.append(labelSpan, noteSpan);

        input.addEventListener('change', () => {
          document.querySelectorAll('.export-option.active').forEach(active => active.classList.remove('active'));
          option.classList.add('active');
          selectedExportFormat = input.value;
          exportConfirmBtn.disabled = false;
        });

        option.append(input, kicker, details);
        exportOptionsContainer.appendChild(option);
      });
    }

    function handleExportKeydown(event) {
      if (event.key === 'Escape') {
        event.preventDefault();
        closeExportModal();
      }
      if (event.key === 'Tab') {
        const focusable = Array.from(exportModal.querySelectorAll('button, input[type="radio"]'));
        if (focusable.length === 0) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    }

    function openExportModal() {
      renderExportOptions();
      const defaultName = getExportBaseName();
      exportFileNameInput.value = defaultName;
      exportFileNameInput.focus();
      exportFileNameInput.select();
      exportModalPreviousFocus = document.activeElement;
      exportModal.classList.add('show');
      exportModal.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleExportKeydown);
    }

    function closeExportModal() {
      exportModal.classList.remove('show');
      exportModal.setAttribute('aria-hidden', 'true');
      document.removeEventListener('keydown', handleExportKeydown);
      document.querySelectorAll('.export-option.active').forEach(active => active.classList.remove('active'));
      exportConfirmBtn.disabled = true;
      selectedExportFormat = null;
      if (exportModalPreviousFocus && typeof exportModalPreviousFocus.focus === 'function') {
        exportModalPreviousFocus.focus();
      }
    }

    exportModal.addEventListener('click', (event) => {
      if (event.target === exportModal) {
        closeExportModal();
      }
    });
    exportCloseBtn.addEventListener('click', closeExportModal);
    exportCancelBtn.addEventListener('click', closeExportModal);
    exportConfirmBtn.addEventListener('click', handleExportConfirm);
    exportFileNameInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !exportConfirmBtn.disabled) {
        event.preventDefault();
        handleExportConfirm();
      }
    });

    async function handleExportConfirm() {
      if (!selectedExportFormat) return;
      const rawName = exportFileNameInput.value.trim();
      const safeName = sanitizeFileName(rawName) || getExportBaseName();
      closeExportModal();
      await exportPresentation(selectedExportFormat, safeName);
    }

    async function waitForRenderCycles(cycles = 2) {
      while (cycles-- > 0) {
        await new Promise(resolve => requestAnimationFrame(() => resolve()));
      }
    }

    async function captureSlideSnapshot(type = 'png') {
      await waitForRenderCycles(2);
      const canvasWrapper = document.querySelector('.canvas');
      if (!canvasWrapper) {
        throw new Error('Presentation canvas not found.');
      }
      document.activeElement && document.activeElement.blur();
      canvasWrapper.classList.add('exporting');
      await waitForRenderCycles(1);
      const slideCanvas = canvasWrapper.querySelector('.slide-canvas');
      const backgroundColor = type === 'png' ? null : '#ffffff';
      const rendered = await html2canvas(slideCanvas, {
        backgroundColor,
        scale: 2,
        logging: false,
        useCORS: true
      });
      canvasWrapper.classList.remove('exporting');
      const mime = type === 'jpg' ? 'image/jpeg' : 'image/png';
      return {
        dataUrl: rendered.toDataURL(mime, 0.92),
        width: rendered.width,
        height: rendered.height
      };
    }

    function generateStandaloneHTMLDocument(baseName) {
      const slidesJSON = JSON.stringify(slides).replace(/<\/script>/gi, '<\\/script>');
      const lines = [
        "<!doctype html>",
        "<html lang=\"en\">",
        "<head>",
        "  <meta charset=\"utf-8\">",
        "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">",
        `  <title>${baseName} – Slide Export</title>`,
        "  <style>",
        "    body { font-family: 'Poppins', Arial, sans-serif; margin: 0; padding: 40px; background: #01231a; color: #e8f5e9; }",
        "    .deck { display: grid; gap: 32px; max-width: 960px; margin: 0 auto; }",
        "    .slide { background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 18px; padding: 32px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); }",
        "    .slide h2 { margin: 0 0 16px; font-size: 1.8rem; color: #9ef6c7; }",
        "    .slide-content { line-height: 1.6; }",
        "  </style>",
        "</head>",
        "<body>",
        "  <main class=\"deck\" id=\"deck\"></main>",
        "  <script>",
        `    const slides = ${slidesJSON};`,
        "    const deck = document.getElementById('deck');",
        "    slides.forEach((slide, index) => {",
        "      const section = document.createElement('section');",
        "      section.className = 'slide';",
        "      const title = document.createElement('h2');",
        "      title.textContent = slide.title && slide.title.trim() ? slide.title.trim() : 'Slide ' + (index + 1);",
        "      section.appendChild(title);",
        "      const content = document.createElement('div');",
        "      content.className = 'slide-content';",
        "      content.innerHTML = slide.html || '';",
        "      section.appendChild(content);",
        "      deck.appendChild(section);",
        "    });",
        "  <\\/script>",
        "</body>",
        "</html>"
      ];
      return lines.join('\\n');
    }

    async function exportAsPDF(baseName) {
      if (!window.html2canvas || !window.jspdf) {
        throw new Error('PDF export libraries are not available.');
      }
      console.log('Generating file blob… (PDF)');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      const originalId = selectedId;
      for (let i = 0; i < slides.length; i += 1) {
        selectedId = slides[i].id;
        render();
        const snapshot = await captureSlideSnapshot('png');
        if (i > 0) {
          pdf.addPage();
        }
        const pageWidth = pdf.internal.pageSize.getWidth() - 60;
        const ratio = snapshot.height === 0 ? 1 : snapshot.width / snapshot.height;
        const imageHeight = pageWidth / ratio;
        const maxHeight = pdf.internal.pageSize.getHeight() - 60;
        const heightToUse = Math.min(imageHeight, maxHeight);
        const widthToUse = heightToUse * ratio;
        pdf.addImage(snapshot.dataUrl, 'PNG', 30, 30, widthToUse, heightToUse);
      }
      selectedId = originalId;
      render();
      const fileNameOut = `${baseName}.pdf`;
      const pdfBlob = pdf.output('blob');
      downloadBlob(pdfBlob, fileNameOut);
      return fileNameOut;
    }

    async function exportAsPPTX(baseName) {
      if (!window.PptxGenJS) {
        throw new Error('PPTX export library is not available.');
      }
      console.log('Generating file blob… (PPTX)');
      const pptx = new window.PptxGenJS();
      slides.forEach((slide, index) => {
        const pptSlide = pptx.addSlide();
        const titleText = slide.title && slide.title.trim() ? slide.title.trim() : `Slide ${index + 1}`;
        pptSlide.addText(titleText, {
          x: 0.6,
          y: 0.5,
          fontSize: 26,
          bold: true,
          color: '2dd4bf'
        });
        const temp = document.createElement('div');
        temp.innerHTML = slide.html || '';
        const bodyText = (temp.textContent || temp.innerText || '').trim();
        if (bodyText) {
          pptSlide.addText(bodyText, {
            x: 0.6,
            y: 1.25,
            w: 8.4,
            h: 4.5,
            fontSize: 18,
            color: '173f35',
            lineSpacing: 28
          });
        }
      });
      const fileNameOut = `${baseName}.pptx`;
      const pptxBlob = await pptx.write('blob');
      downloadBlob(pptxBlob, fileNameOut);
      return fileNameOut;
    }

    async function exportSlidesAsImages(baseName, type) {
      if (!window.html2canvas || !window.JSZip) {
        throw new Error('Image export libraries are not available.');
      }
      console.log(`Generating file blob… (${type.toUpperCase()} ZIP)`);
      const zip = new JSZip();
      const originalId = selectedId;
      for (let i = 0; i < slides.length; i += 1) {
        selectedId = slides[i].id;
        render();
        const snapshot = await captureSlideSnapshot(type);
        const fileName = `slide-${String(i + 1).padStart(2, '0')}.${type}`;
        zip.file(fileName, snapshot.dataUrl.split(',')[1], { base64: true });
      }
      selectedId = originalId;
      render();
      const blob = await zip.generateAsync({ type: 'blob' });
      const zipName = `${baseName}-${type.toUpperCase()}-slides.zip`;
      downloadBlob(blob, zipName);
      return zipName;
    }

    function exportAsHTML(baseName) {
      console.log('Generating file blob… (HTML)');
      const htmlDocument = generateStandaloneHTMLDocument(baseName);
      const blob = new Blob([htmlDocument], { type: 'text/html;charset=utf-8' });
      const fileNameOut = `${baseName}.html`;
      downloadBlob(blob, fileNameOut);
      return fileNameOut;
    }

    function exportAsJSON(baseName) {
      console.log('Generating file blob… (JSON)');
      const payload = {
        generatedAt: new Date().toISOString(),
        fileName,
        slides
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const fileNameOut = `${baseName}.json`;
      downloadBlob(blob, fileNameOut);
      return fileNameOut;
    }

    async function exportPresentation(format, customBaseName) {
      const label = EXPORT_LABEL_MAP[format] || format.toUpperCase();
      showToast(`Preparing ${label}…`, null);
      try {
        updateCurrentFromEditor();
        const baseName = sanitizeFileName(customBaseName || getExportBaseName());
        let exportedFileName = '';
        if (format === 'pdf') {
          exportedFileName = await exportAsPDF(baseName);
        } else if (format === 'pptx') {
          exportedFileName = await exportAsPPTX(baseName);
        } else if (format === 'png') {
          exportedFileName = await exportSlidesAsImages(baseName, 'png');
        } else if (format === 'jpg') {
          exportedFileName = await exportSlidesAsImages(baseName, 'jpg');
        } else if (format === 'html') {
          exportedFileName = exportAsHTML(baseName);
        } else if (format === 'json') {
          exportedFileName = exportAsJSON(baseName);
        } else {
          throw new Error('Unsupported format selected.');
        }
        hideToast();
        showToast('✅ File saved successfully to your Downloads folder.', 3000);
      } catch (error) {
        console.error('Export failed:', error);
        hideToast();
        alert(`Export failed: ${error.message || error}`);
      }
    }

    function uid() { return 's_' + Math.random().toString(36).slice(2, 10); }
    function now() { return Date.now(); }

    function createSlide(partial) {
      return {
        id: uid(),
        title: (partial && partial.title) || 'Untitled',
        html: (partial && partial.html) || '',
        createdAt: now(),
        updatedAt: now(),
      };
    }

    function save() { localStorage.setItem(storageKey, JSON.stringify({ slides, selectedId, fileName })); }
    function load() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) throw new Error('empty');
        const data = JSON.parse(raw);
        slides = Array.isArray(data.slides) ? data.slides : [];
        selectedId = data.selectedId || (slides[0] && slides[0].id) || null;
        fileName = data.fileName || fileName;
      } catch (e) {
        slides = [createSlide({ title: 'Welcome', html: '<p>Start building your deck.</p>' })];
        selectedId = slides[0].id;
      }
    }

    function selectedIndex() { return slides.findIndex(s => s.id === selectedId); }
    function currentSlide() { return slides.find(s => s.id === selectedId) || null; }

    function addSlide() {
      const idx = selectedIndex();
      const s = createSlide({ title: 'New slide' });
      if (idx >= 0) slides.splice(idx + 1, 0, s); else slides.push(s);
      selectedId = s.id; render(); save(); titleEl.focus(); titleEl.select();
    }
    function duplicateSlide() {
      const cur = currentSlide(); if (!cur) return;
      const s = createSlide({ title: cur.title + ' (copy)', html: cur.html });
      slides.splice(selectedIndex() + 1, 0, s); selectedId = s.id; render(); save();
    }
    function deleteSlide() {
      const idx = selectedIndex(); if (idx < 0) return;
      slides.splice(idx, 1);
      if (!slides.length) { const s = createSlide({ title: 'New slide' }); slides.push(s); selectedId = s.id; }
      else { selectedId = slides[Math.max(0, idx - 1)].id; }
      render(); save();
    }
    function selectSlide(id) { selectedId = id; render(); save(); }

    function updateCurrentFromEditor() {
      const cur = currentSlide(); if (!cur) return;
      cur.title = titleEl.value.trim() || 'Untitled';
      cur.html = contentEl.innerHTML; cur.updatedAt = now();
      const t = document.querySelector(`.slide-item[data-id="${cur.id}"] .slide-title`);
      if (t) t.textContent = cur.title; save();
    }

    function escapeHtml(str) {
      return (str || '')
        .replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }

    function thumbHTML(slide) {
      const title = (slide.title || '').replaceAll('<','&lt;').replaceAll('>','&gt;');
      return `
        <div class="mini slide-canvas" style="width:530px;height:300px;border-radius:8px;padding:20px;">
          <div style="font-weight:800;font-size:28px;border-bottom:1px dashed #d1d5db;margin-bottom:8px;">${title}</div>
          <div>${slide.html || ''}</div>
        </div>`;
    }

    function renderList() {
      slidesEl.innerHTML = '';
      slides.forEach((s, i) => {
        const item = document.createElement('div');
        item.className = 'slide-item' + (s.id === selectedId ? ' active' : '');
        item.dataset.id = s.id;
        item.innerHTML = `
          <div class="thumb"><div>${thumbHTML(s)}</div></div>
          <div>
            <div class="slide-title">${escapeHtml(s.title)}</div>
            <div class="slide-meta">Slide ${i + 1}</div>
          </div>
          <div style=\"display:flex;gap:6px;\">
            <button class=\"btn-secondary btn-mini\" data-action=\"dup\">⎘</button>
            <button class=\"btn-danger btn-mini\" data-action=\"del\">×</button>
          </div>`;
        item.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (btn && btn.dataset.action === 'dup') { duplicateSlide(); e.stopPropagation(); return; }
          if (btn && btn.dataset.action === 'del') { deleteSlide(); e.stopPropagation(); return; }
          selectSlide(s.id);
        });
        slidesEl.appendChild(item);
      });
      countEl.textContent = slides.length + ' slides';
    }

    function renderEditor() {
      const cur = currentSlide(); if (!cur) return;
      titleEl.value = cur.title; contentEl.innerHTML = cur.html; fileNameEl.value = fileName;
    }
    function render() { renderList(); renderEditor(); }

    // Toolbar commands
    document.querySelectorAll('[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmd = btn.getAttribute('data-cmd');
        const val = btn.getAttribute('data-value');
        contentEl.focus(); document.execCommand(cmd, false, val); updateCurrentFromEditor();
      });
    });

    // Buttons
    document.getElementById('btn-new').addEventListener('click', addSlide);
    document.getElementById('btn-duplicate').addEventListener('click', duplicateSlide);
    document.getElementById('btn-delete').addEventListener('click', deleteSlide);
    document.getElementById('btn-clear').addEventListener('click', () => {
      if (!confirm('Reset all slides?')) return;
      slides = [createSlide({ title: 'Welcome', html: '<p>Blank deck.</p>' })]; selectedId = slides[0].id; render(); save();
    });
    document.getElementById('btn-export').addEventListener('click', () => {
      updateCurrentFromEditor();
      openExportModal();
    });

    // Editor listeners
    titleEl.addEventListener('input', updateCurrentFromEditor);
    contentEl.addEventListener('input', updateCurrentFromEditor);
    fileNameEl.addEventListener('input', () => { fileName = fileNameEl.value || 'Untitled presentation'; save(); });

    // Keyboard navigation
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') { const i = Math.min(slides.length - 1, selectedIndex() + 1); selectedId = slides[i].id; render(); e.preventDefault(); }
      else if (e.key === 'ArrowUp') { const i = Math.max(0, selectedIndex() - 1); selectedId = slides[i].id; render(); e.preventDefault(); }
      else if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) { addSlide(); e.preventDefault(); }
      else if (e.key === 'Backspace' && (e.metaKey || e.ctrlKey)) { deleteSlide(); e.preventDefault(); }
    });

    load();
    render();
  </script>
</body>
</html>


